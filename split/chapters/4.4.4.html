<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="description" content="4.4.4  Implementing the Query System" />
    <title>
      4.4.4  Implementing the Query System
    </title>
    
  <meta name="csrf-param" content="authenticity_token" />
  <meta name="csrf-token" content="EMTEijVc2kiiKUH4nYH0lQG3pLPfMowQ/Stg//t6DCo0e5pWMQwamnTvIdmVZqY/MqSx2IYYE+2bpNV6UNSMwQ==" />

    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    -->
    <link href="https://fonts.googleapis.com/css?family=Inconsolata&display?swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans|Droid+Serif" rel="stylesheet">
    <link rel="stylesheet" media="all" href="../assets/stylesheet.css" />

   <link rel="shortcut icon" type="image/x-icon" href="../assets/favicon.ico" />

<!--    <link rel="shortcut icon" type="image/png" href="../images/lambda.png" /> -->

    <!-- for support of progressive web app, see github README, DISABLED!
    <link rel="manifest" href="../static/manifest.json">
    -->

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" 
		     	  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
	          crossorigin="anonymous">
    </script> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script> -->
    <script type="text/javascript" 
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-AMS-MML_HTMLorMML-full">
    </script>
   <!--  <script type="text/javascript" 
      src="../MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML-full">
    </script> -->
  
    <script src="../assets/application.js"></script>
  
    <!-- Rendering inline LaTeX -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true,
          jax: ["input/TeX","output/HTML-CSS"]
        }
      });
    </script>
    <!--<script src="/mathjax/MathJax.js?config=TeX-AMS_HTML-full.js" type="text/javascript"></script>-->
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js" type="text/javascript"></script>
    <![endif]-->
  </head>
  <body>

    
    <!-- support for progressive web app, see README, DISABLED
    <script>
      if ('serviceWorker' in navigator && !navigator.serviceWorker.controller) {
          navigator.serviceWorker.register("../sw.js").then(function(reg) {
              console.log("Service worker has been registered for scope: " + reg.scope);
          });
      }
    </script>
    -->

     <nav class="navbar navbar-expand-sm navbar-dark bg-dark fixed-top justify-content-between">
       <button id="btn" class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#nav-sidebar" aria-controls="nav-sidebar" aria-expanded="false" aria-label="Toggle navigation" title="navigation">
         <span class="navbar-toggler-icon"></span>
       </button>
       <span class="navbar-brand-short"><a title="Go back to front page" href="../index.html" class="gray">SICP &mdash; Scheme/JS</a></span>
       <span class="navbar-brand-long" ><a title="Go back to front page" href="../index.html" class="gray">Structure and Interpretation of Computer Programs &mdash; Comparison Edition</a></span>

       <!-- edit the search engine by visiting: 
	    https://cse.google.com/cse/setup/basic?cx=015760785273492757659:nc_tznrzlsg 
	       -->
       <form class="form-inline ml-auto" id="xxx">
         <div id="search-box">
	         <script>
	           (function() {
	               var cx = "015760785273492757659:nc_tznrzlsg";
	               var gcse = document.createElement("script");
	               gcse.type = "text/javascript";
	               gcse.async = true;
	               gcse.src = "https://cse.google.com/cse.js?cx=" + cx;
	               var s = document.getElementsByTagName("script")[0];
	               s.parentNode.insertBefore(gcse, s);
	           })();
	           window.onload = function()
	           { 
	               var searchBox =  document.getElementById("gsc-i-id1");
	               searchBox.placeholder="search web edition";
	               searchBox.title="search web edition"; 
	           }
	         </script>
	         <gcse:search></gcse:search>
         </div>
       </form>
       <span class="navbar-brand-short">
         &nbsp;
         &nbsp;
         <a href="https://sicp.comp.nus.edu.sg/source/" title="Go to the Source language(s) definition(s)" class="gray">S</a>
       </span>
       <span class="navbar-brand-long">
         &nbsp;
         &nbsp;
         <a href="https://sicp.comp.nus.edu.sg/source/" title="Go to the Source language(s) definition(s)" class="gray">Source</a>
       </span>
     </nav>
     
     <div class="container scroll">

            
        <div class="collapse" id="nav-sidebar" role="tablist" aria-multiselectable="true">
        <!-- insert a dummy entry, to give one extra line of space -->
        <a class="navbar-brand" href="index.html">&nbsp;</a>
    
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-1">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-1" aria-expanded="false" aria-controls="sidebar-collapse-1">
                <a href="./foreword.html">  Foreword</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-2">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-2" aria-expanded="false" aria-controls="sidebar-collapse-2">
                <a href="./prefaces.html">  Prefaces</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-3">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-3" aria-expanded="false" aria-controls="sidebar-collapse-3">
                <a href="./acknowledgements.html">  Acknowledgments from Second Edition of SICP, 1996</a>
              </span>
            </h5>
          </div>
        </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-4">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-4" aria-expanded="true" aria-controls="sidebar-collapse-4">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-4" aria-expanded="true" aria-controls="sidebar-collapse-4">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./1.html">1  Building Abstractions with <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span></a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-4" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-5">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-5" aria-expanded="true" aria-controls="sidebar-collapse-5">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-5" aria-expanded="true" aria-controls="sidebar-collapse-5">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./1.1.html">1.1  The Elements of Programming</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-5" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-6">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-6" aria-expanded="false" aria-controls="sidebar-collapse-6">
                <a href="./1.1.1.html"> 1.1.1  Expressions</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-7">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-7" aria-expanded="false" aria-controls="sidebar-collapse-7">
                <a href="./1.1.2.html"> 1.1.2  Naming and the Environment</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-8">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-8" aria-expanded="false" aria-controls="sidebar-collapse-8">
                <a href="./1.1.3.html"> 1.1.3  Evaluating <span style="color:teal"> Combinations </span> <span style="color:blue"> Operator Combinations </span></a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-9">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-9" aria-expanded="false" aria-controls="sidebar-collapse-9">
                <a href="./1.1.4.html"> 1.1.4  Compound <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span></a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-10">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-10" aria-expanded="false" aria-controls="sidebar-collapse-10">
                <a href="./1.1.5.html"> 1.1.5  The Substitution Model for <span style="color:teal"> Procedure </span> <span style="color:blue"> Function </span> Application</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-11">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-11" aria-expanded="false" aria-controls="sidebar-collapse-11">
                <a href="./1.1.6.html"> 1.1.6  Conditional Expressions and Predicates</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-12">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-12" aria-expanded="false" aria-controls="sidebar-collapse-12">
                <a href="./1.1.7.html"> 1.1.7  Example: Square Roots by Newton s Method</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-13">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-13" aria-expanded="false" aria-controls="sidebar-collapse-13">
                <a href="./1.1.8.html"> 1.1.8  <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span> as Black-Box Abstractions</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-14">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-14" aria-expanded="true" aria-controls="sidebar-collapse-14">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-14" aria-expanded="true" aria-controls="sidebar-collapse-14">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./1.2.html">1.2  <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span> and the Processes They Generate</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-14" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-15">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-15" aria-expanded="false" aria-controls="sidebar-collapse-15">
                <a href="./1.2.1.html"> 1.2.1  Linear Recursion and Iteration</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-16">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-16" aria-expanded="false" aria-controls="sidebar-collapse-16">
                <a href="./1.2.2.html"> 1.2.2  Tree Recursion</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-17">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-17" aria-expanded="false" aria-controls="sidebar-collapse-17">
                <a href="./1.2.3.html"> 1.2.3  Orders of Growth</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-18">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-18" aria-expanded="false" aria-controls="sidebar-collapse-18">
                <a href="./1.2.4.html"> 1.2.4  Exponentiation</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-19">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-19" aria-expanded="false" aria-controls="sidebar-collapse-19">
                <a href="./1.2.5.html"> 1.2.5  Greatest Common Divisors</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-20">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-20" aria-expanded="false" aria-controls="sidebar-collapse-20">
                <a href="./1.2.6.html"> 1.2.6  Example: Testing for Primality</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-21">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-21" aria-expanded="true" aria-controls="sidebar-collapse-21">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-21" aria-expanded="true" aria-controls="sidebar-collapse-21">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./1.3.html">1.3  Formulating Abstractions with Higher-Order <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span></a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-21" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-22">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-22" aria-expanded="false" aria-controls="sidebar-collapse-22">
                <a href="./1.3.1.html"> 1.3.1  <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span> as Arguments</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-23">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-23" aria-expanded="false" aria-controls="sidebar-collapse-23">
                <a href="./1.3.2.html"> 1.3.2  <span style="color:teal"> Constructing Procedures using Lambda </span> <span style="color:blue"> Constructing Functions using Lambda Expressions </span></a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-24">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-24" aria-expanded="false" aria-controls="sidebar-collapse-24">
                <a href="./1.3.3.html"> 1.3.3  <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span> as General Methods</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-25">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-25" aria-expanded="false" aria-controls="sidebar-collapse-25">
                <a href="./1.3.4.html"> 1.3.4  <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span> as Returned Values</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-26">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-26" aria-expanded="true" aria-controls="sidebar-collapse-26">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-26" aria-expanded="true" aria-controls="sidebar-collapse-26">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./2.html">2  Building Abstractions with Data</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-26" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-27">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-27" aria-expanded="true" aria-controls="sidebar-collapse-27">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-27" aria-expanded="true" aria-controls="sidebar-collapse-27">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./2.1.html">2.1  Introduction to Data Abstraction</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-27" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-28">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-28" aria-expanded="false" aria-controls="sidebar-collapse-28">
                <a href="./2.1.1.html"> 2.1.1  Example: Arithmetic Operations for Rational Numbers</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-29">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-29" aria-expanded="false" aria-controls="sidebar-collapse-29">
                <a href="./2.1.2.html"> 2.1.2  Abstraction Barriers</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-30">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-30" aria-expanded="false" aria-controls="sidebar-collapse-30">
                <a href="./2.1.3.html"> 2.1.3  What Is Meant by Data?</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-31">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-31" aria-expanded="false" aria-controls="sidebar-collapse-31">
                <a href="./2.1.4.html"> 2.1.4  Extended Exercise: Interval Arithmetic</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-32">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-32" aria-expanded="true" aria-controls="sidebar-collapse-32">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-32" aria-expanded="true" aria-controls="sidebar-collapse-32">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./2.2.html">2.2  Hierarchical Data and the Closure Property</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-32" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-33">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-33" aria-expanded="false" aria-controls="sidebar-collapse-33">
                <a href="./2.2.1.html"> 2.2.1  Representing Sequences</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-34">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-34" aria-expanded="false" aria-controls="sidebar-collapse-34">
                <a href="./2.2.2.html"> 2.2.2  Hierarchical Structures</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-35">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-35" aria-expanded="false" aria-controls="sidebar-collapse-35">
                <a href="./2.2.3.html"> 2.2.3  Sequences as Conventional Interfaces</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-36">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-36" aria-expanded="false" aria-controls="sidebar-collapse-36">
                <a href="./2.2.4.html"> 2.2.4  Example: A Picture Language</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-37">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-37" aria-expanded="true" aria-controls="sidebar-collapse-37">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-37" aria-expanded="true" aria-controls="sidebar-collapse-37">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./2.3.html">2.3  Symbolic Data</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-37" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-38">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-38" aria-expanded="false" aria-controls="sidebar-collapse-38">
                <a href="./2.3.1.html"> 2.3.1  <span style="color:teal"> Quotation </span> <span style="color:blue"> Strings </span></a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-39">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-39" aria-expanded="false" aria-controls="sidebar-collapse-39">
                <a href="./2.3.2.html"> 2.3.2  Example: Symbolic Differentiation</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-40">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-40" aria-expanded="false" aria-controls="sidebar-collapse-40">
                <a href="./2.3.3.html"> 2.3.3  Example: Representing Sets</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-41">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-41" aria-expanded="false" aria-controls="sidebar-collapse-41">
                <a href="./2.3.4.html"> 2.3.4  Example: Huffman Encoding Trees</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-42">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-42" aria-expanded="true" aria-controls="sidebar-collapse-42">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-42" aria-expanded="true" aria-controls="sidebar-collapse-42">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./2.4.html">2.4  Multiple Representations for Abstract Data</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-42" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-43">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-43" aria-expanded="false" aria-controls="sidebar-collapse-43">
                <a href="./2.4.1.html"> 2.4.1  Representations for Complex Numbers</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-44">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-44" aria-expanded="false" aria-controls="sidebar-collapse-44">
                <a href="./2.4.2.html"> 2.4.2  Tagged data</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-45">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-45" aria-expanded="false" aria-controls="sidebar-collapse-45">
                <a href="./2.4.3.html"> 2.4.3  Data-Directed Programming and Additivity</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-46">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-46" aria-expanded="true" aria-controls="sidebar-collapse-46">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-46" aria-expanded="true" aria-controls="sidebar-collapse-46">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./2.5.html">2.5  Systems with Generic Operations</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-46" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-47">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-47" aria-expanded="false" aria-controls="sidebar-collapse-47">
                <a href="./2.5.1.html"> 2.5.1  Generic Arithmetic Operations</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-48">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-48" aria-expanded="false" aria-controls="sidebar-collapse-48">
                <a href="./2.5.2.html"> 2.5.2  Combining Data of Different Types</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-49">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-49" aria-expanded="false" aria-controls="sidebar-collapse-49">
                <a href="./2.5.3.html"> 2.5.3  Example: Symbolic Algebra</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-50">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-50" aria-expanded="true" aria-controls="sidebar-collapse-50">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-50" aria-expanded="true" aria-controls="sidebar-collapse-50">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./3.html">3  Modularity, Objects, and State</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-50" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-51">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-51" aria-expanded="true" aria-controls="sidebar-collapse-51">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-51" aria-expanded="true" aria-controls="sidebar-collapse-51">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./3.1.html">3.1  Assignment and Local State</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-51" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-52">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-52" aria-expanded="false" aria-controls="sidebar-collapse-52">
                <a href="./3.1.1.html"> 3.1.1  Local State Variables</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-53">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-53" aria-expanded="false" aria-controls="sidebar-collapse-53">
                <a href="./3.1.2.html"> 3.1.2  The Benefits of Introducing Assignment</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-54">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-54" aria-expanded="false" aria-controls="sidebar-collapse-54">
                <a href="./3.1.3.html"> 3.1.3  The Costs of Introducing Assignment</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-55">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-55" aria-expanded="true" aria-controls="sidebar-collapse-55">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-55" aria-expanded="true" aria-controls="sidebar-collapse-55">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./3.2.html">3.2  The Environment Model of Evaluation</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-55" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-56">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-56" aria-expanded="false" aria-controls="sidebar-collapse-56">
                <a href="./3.2.1.html"> 3.2.1  The Rules for Evaluation</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-57">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-57" aria-expanded="false" aria-controls="sidebar-collapse-57">
                <a href="./3.2.2.html"> 3.2.2  Applying Simple <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span></a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-58">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-58" aria-expanded="false" aria-controls="sidebar-collapse-58">
                <a href="./3.2.3.html"> 3.2.3  Frames as the Repository of Local State</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-59">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-59" aria-expanded="false" aria-controls="sidebar-collapse-59">
                <a href="./3.2.4.html"> 3.2.4  Internal <span style="color:teal"> Definitions </span> <span style="color:blue"> Declarations </span></a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-60">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-60" aria-expanded="true" aria-controls="sidebar-collapse-60">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-60" aria-expanded="true" aria-controls="sidebar-collapse-60">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./3.3.html">3.3  Modeling with Mutable Data</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-60" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-61">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-61" aria-expanded="false" aria-controls="sidebar-collapse-61">
                <a href="./3.3.1.html"> 3.3.1  Mutable List Structure</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-62">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-62" aria-expanded="false" aria-controls="sidebar-collapse-62">
                <a href="./3.3.2.html"> 3.3.2  Representing Queues</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-63">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-63" aria-expanded="false" aria-controls="sidebar-collapse-63">
                <a href="./3.3.3.html"> 3.3.3  Representing Tables</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-64">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-64" aria-expanded="false" aria-controls="sidebar-collapse-64">
                <a href="./3.3.4.html"> 3.3.4  A Simulator for Digital Circuits</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-65">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-65" aria-expanded="false" aria-controls="sidebar-collapse-65">
                <a href="./3.3.5.html"> 3.3.5  Propagation of Constraints</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-66">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-66" aria-expanded="true" aria-controls="sidebar-collapse-66">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-66" aria-expanded="true" aria-controls="sidebar-collapse-66">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./3.4.html">3.4  Concurrency: Time Is of the Essence</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-66" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-67">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-67" aria-expanded="false" aria-controls="sidebar-collapse-67">
                <a href="./3.4.1.html"> 3.4.1  The Nature of Time in Concurrent Systems</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-68">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-68" aria-expanded="false" aria-controls="sidebar-collapse-68">
                <a href="./3.4.2.html"> 3.4.2  Mechanisms for Controlling Concurrency</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-69">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-69" aria-expanded="true" aria-controls="sidebar-collapse-69">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-69" aria-expanded="true" aria-controls="sidebar-collapse-69">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./3.5.html">3.5  Streams</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-69" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-70">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-70" aria-expanded="false" aria-controls="sidebar-collapse-70">
                <a href="./3.5.1.html"> 3.5.1  Streams Are Delayed Lists</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-71">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-71" aria-expanded="false" aria-controls="sidebar-collapse-71">
                <a href="./3.5.2.html"> 3.5.2  Infinite Streams</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-72">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-72" aria-expanded="false" aria-controls="sidebar-collapse-72">
                <a href="./3.5.3.html"> 3.5.3  Exploiting the Stream Paradigm</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-73">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-73" aria-expanded="false" aria-controls="sidebar-collapse-73">
                <a href="./3.5.4.html"> 3.5.4  Streams and Delayed Evaluation</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-74">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-74" aria-expanded="false" aria-controls="sidebar-collapse-74">
                <a href="./3.5.5.html"> 3.5.5  Modularity of Functional Programs and Modularity of Objects</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-75">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-75" aria-expanded="true" aria-controls="sidebar-collapse-75">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-75" aria-expanded="true" aria-controls="sidebar-collapse-75">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./4.html">4  Metalinguistic Abstraction</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-75" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-76">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-76" aria-expanded="true" aria-controls="sidebar-collapse-76">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-76" aria-expanded="true" aria-controls="sidebar-collapse-76">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./4.1.html">4.1  The Metacircular Evaluator</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-76" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-77">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-77" aria-expanded="false" aria-controls="sidebar-collapse-77">
                <a href="./4.1.1.html"> 4.1.1  The Core of the Evaluator</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-78">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-78" aria-expanded="false" aria-controls="sidebar-collapse-78">
                <a href="./4.1.2.html"> 4.1.2  Representing <span style="color:teal"> Expressions </span> <span style="color:blue"> Statements and Expressions </span></a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-79">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-79" aria-expanded="false" aria-controls="sidebar-collapse-79">
                <a href="./4.1.3.html"> 4.1.3  Evaluator Data Structures</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-80">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-80" aria-expanded="false" aria-controls="sidebar-collapse-80">
                <a href="./4.1.4.html"> 4.1.4  Running the Evaluator as a Program</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-81">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-81" aria-expanded="false" aria-controls="sidebar-collapse-81">
                <a href="./4.1.5.html"> 4.1.5  Data as Programs</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-82">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-82" aria-expanded="false" aria-controls="sidebar-collapse-82">
                <a href="./4.1.6.html"> 4.1.6  Internal <span style="color:teal"> Definitions </span> <span style="color:blue"> Declarations </span></a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-83">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-83" aria-expanded="false" aria-controls="sidebar-collapse-83">
                <a href="./4.1.7.html"> 4.1.7  Separating Syntactic Analysis from Execution</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-84">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-84" aria-expanded="true" aria-controls="sidebar-collapse-84">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-84" aria-expanded="true" aria-controls="sidebar-collapse-84">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./4.2.html">4.2  <span style="color:teal"> Variations on a Scheme: </span> Lazy Evaluation</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-84" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-85">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-85" aria-expanded="false" aria-controls="sidebar-collapse-85">
                <a href="./4.2.1.html"> 4.2.1  Normal Order and Applicative Order</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-86">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-86" aria-expanded="false" aria-controls="sidebar-collapse-86">
                <a href="./4.2.2.html"> 4.2.2  An Interpreter with Lazy Evaluation</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-87">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-87" aria-expanded="false" aria-controls="sidebar-collapse-87">
                <a href="./4.2.3.html"> 4.2.3  Streams as Lazy Lists</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-88">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-88" aria-expanded="true" aria-controls="sidebar-collapse-88">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-88" aria-expanded="true" aria-controls="sidebar-collapse-88">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./4.3.html">4.3  <span style="color:teal"> Variations on a Scheme: </span> Nondeterministic Computing</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-88" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-89">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-89" aria-expanded="false" aria-controls="sidebar-collapse-89">
                <a href="./4.3.1.html"> 4.3.1  Amb and Search</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-90">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-90" aria-expanded="false" aria-controls="sidebar-collapse-90">
                <a href="./4.3.2.html"> 4.3.2  Examples of Nondeterministic Programs</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-91">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-91" aria-expanded="false" aria-controls="sidebar-collapse-91">
                <a href="./4.3.3.html"> 4.3.3  Implementing the <span style="color:teal"> Amb </span> <span style="color:blue"> amb </span> Evaluator</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-92">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-92" aria-expanded="true" aria-controls="sidebar-collapse-92">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-92" aria-expanded="true" aria-controls="sidebar-collapse-92">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./4.4.html">4.4  Logic Programming</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-92" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-93">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-93" aria-expanded="false" aria-controls="sidebar-collapse-93">
                <a href="./4.4.1.html"> 4.4.1  Deductive Information Retrieval</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-94">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-94" aria-expanded="false" aria-controls="sidebar-collapse-94">
                <a href="./4.4.2.html"> 4.4.2  How the Query System Works</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-95">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-95" aria-expanded="false" aria-controls="sidebar-collapse-95">
                <a href="./4.4.3.html"> 4.4.3  Is Logic Programming Mathematical Logic?</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-96">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-96" aria-expanded="false" aria-controls="sidebar-collapse-96">
                <a href="./4.4.4.html"> 4.4.4  Implementing the Query System</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-97">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-97" aria-expanded="true" aria-controls="sidebar-collapse-97">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-97" aria-expanded="true" aria-controls="sidebar-collapse-97">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./5.html">5  Computing with Register Machines</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-97" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-98">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-98" aria-expanded="true" aria-controls="sidebar-collapse-98">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-98" aria-expanded="true" aria-controls="sidebar-collapse-98">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./5.1.html">5.1  Designing Register Machines</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-98" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-99">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-99" aria-expanded="false" aria-controls="sidebar-collapse-99">
                <a href="./5.1.1.html"> 5.1.1  A Language for Describing Register Machines</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-100">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-100" aria-expanded="false" aria-controls="sidebar-collapse-100">
                <a href="./5.1.2.html"> 5.1.2  Abstraction in Machine Design</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-101">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-101" aria-expanded="false" aria-controls="sidebar-collapse-101">
                <a href="./5.1.3.html"> 5.1.3  Subroutines</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-102">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-102" aria-expanded="false" aria-controls="sidebar-collapse-102">
                <a href="./5.1.4.html"> 5.1.4  Using a Stack to Implement Recursion</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-103">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-103" aria-expanded="false" aria-controls="sidebar-collapse-103">
                <a href="./5.1.5.html"> 5.1.5  Instruction Summary</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-104">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-104" aria-expanded="true" aria-controls="sidebar-collapse-104">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-104" aria-expanded="true" aria-controls="sidebar-collapse-104">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./5.2.html">5.2  A Register-Machine Simulator</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-104" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-105">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-105" aria-expanded="false" aria-controls="sidebar-collapse-105">
                <a href="./5.2.1.html"> 5.2.1  The Machine Model</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-106">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-106" aria-expanded="false" aria-controls="sidebar-collapse-106">
                <a href="./5.2.2.html"> 5.2.2  The Assembler</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-107">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-107" aria-expanded="false" aria-controls="sidebar-collapse-107">
                <a href="./5.2.3.html"> 5.2.3  Generating Execution <span style="color:teal"> Procedures </span> <span style="color:blue"> Functions </span> for Instructions</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-108">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-108" aria-expanded="false" aria-controls="sidebar-collapse-108">
                <a href="./5.2.4.html"> 5.2.4  Monitoring Machine Performance</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-109">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-109" aria-expanded="true" aria-controls="sidebar-collapse-109">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-109" aria-expanded="true" aria-controls="sidebar-collapse-109">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./5.3.html">5.3  Storage Allocation and Garbage Collection</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-109" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-110">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-110" aria-expanded="false" aria-controls="sidebar-collapse-110">
                <a href="./5.3.1.html"> 5.3.1  Memory as Vectors</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-111">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-111" aria-expanded="false" aria-controls="sidebar-collapse-111">
                <a href="./5.3.2.html"> 5.3.2  Maintaining the Illusion of Infinite Memory</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-112">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-112" aria-expanded="true" aria-controls="sidebar-collapse-112">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-112" aria-expanded="true" aria-controls="sidebar-collapse-112">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./5.4.html">5.4  The Explicit-Control Evaluator</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-112" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-113">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-113" aria-expanded="false" aria-controls="sidebar-collapse-113">
                <a href="./5.4.1.html"> 5.4.1  The Core of the Explicit-Control Evaluator</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-114">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-114" aria-expanded="false" aria-controls="sidebar-collapse-114">
                <a href="./5.4.2.html"> 5.4.2  Sequence Evaluation and Tail Recursion</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-115">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-115" aria-expanded="false" aria-controls="sidebar-collapse-115">
                <a href="./5.4.3.html"> 5.4.3  Conditionals, Assignments, and Definitions</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-116">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-116" aria-expanded="false" aria-controls="sidebar-collapse-116">
                <a href="./5.4.4.html"> 5.4.4  Running the Evaluator</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
            <div class="card card-inverse">
              <div class="card-header" role="tab" id="sidebar-117">
                <h5 class="mb-0">
                  <a class="sidebar-show collapsed" data-toggle="collapse" href="#sidebar-collapse-117" aria-expanded="true" aria-controls="sidebar-collapse-117">
                  &#10148;   <!-- ➤ (because this one is rendered blue on mobile: ▶  -->
                  </a>
                  <a class="sidebar-hide collapsed" data-toggle="collapse" href="#sidebar-collapse-117" aria-expanded="true" aria-controls="sidebar-collapse-117">
                  &#x25BC;    <!-- ▼ (because the corresponding one is not rendered) -->
                  </a>
                  <a href="./5.5.html">5.5  Compilation</a>
                </h5>
              </div>
    
              <div id="sidebar-collapse-117" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-block">
            
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-118">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-118" aria-expanded="false" aria-controls="sidebar-collapse-118">
                <a href="./5.5.1.html"> 5.5.1  Structure of the Compiler</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-119">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-119" aria-expanded="false" aria-controls="sidebar-collapse-119">
                <a href="./5.5.2.html"> 5.5.2  Compiling Expressions</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-120">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-120" aria-expanded="false" aria-controls="sidebar-collapse-120">
                <a href="./5.5.3.html"> 5.5.3  Compiling Combinations</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-121">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-121" aria-expanded="false" aria-controls="sidebar-collapse-121">
                <a href="./5.5.4.html"> 5.5.4  Combining Instruction Sequences</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-122">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-122" aria-expanded="false" aria-controls="sidebar-collapse-122">
                <a href="./5.5.5.html"> 5.5.5  An Example of Compiled Code</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-123">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-123" aria-expanded="false" aria-controls="sidebar-collapse-123">
                <a href="./5.5.6.html"> 5.5.6  Lexical Addressing</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-124">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-124" aria-expanded="false" aria-controls="sidebar-collapse-124">
                <a href="./5.5.7.html"> 5.5.7  Interfacing Compiled Code to the Evaluator</a>
              </span>
            </h5>
          </div>
        </div>
        
                </div>
              </div>
            </div>
        
                </div>
              </div>
            </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-125">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-125" aria-expanded="false" aria-controls="sidebar-collapse-125">
                <a href="./references.html">  References</a>
              </span>
            </h5>
          </div>
        </div>
        
        <div class="card card-inverse">
          <div class="card-header" role="tab" id="sidebar-126">
            <h5 class="mb-0">
              <span class="collapsed" data-toggle="collapse" href="#sidebar-collapse-126" aria-expanded="false" aria-controls="sidebar-collapse-126">
                <a href="./making-of.html">  Making of the JavaScript Adaptation</a>
              </span>
            </h5>
          </div>
        </div>
        </div>
<div id='permalink-msg'>
<div class='screen'>
  <div class='alert alert-success'>
    <strong>Permalink copied!</strong>
  </div>
</div>
</div>
<div class='chapter-content'>

      <div class='chapter-title'>
        <div class='permalink'>
        <a name='top' class='permalink'> 
    4.4.4  Implementing the Query System
        </a>
        </div>
      </div>
      <div class='chapter-text'>
        <div class='SECTION'><SECTION>
    

      
      <div class='permalink'>
<a name='p1' class='permalink'></a><p>
  Section <REF NAME="sec:how-query-works"><a class="superscript" id="4.4.4-sec-link-4.4.2" href="./4.4.2.html">4.4.2</a></REF> described how the query system
  works. Now we fill in the details by presenting a complete
  implementation of the system.
      </p></div>

      
      <div class='permalink'>
        <a name='sec4.4.4.1' class='permalink'></a><h1>
    4.4.4.1 The Driver Loop and Instantiation</h1></div>
   

  <div class='permalink'>
<a name='p2' class='permalink'></a><p>
    
    
    The driver loop for the query system repeatedly reads input
    expressions.  If the expression is a rule or assertion to be added to
    the data base, then the information is added.  Otherwise the
    expression is assumed to be a query.  The driver passes this query to
    the evaluator <kbd>qeval</kbd> together with an initial frame stream
    consisting of a single empty frame.  The result of the evaluation is a
    stream of frames generated by satisfying the query with variable
    values found in the data base.  These frames are used to form a new
    stream consisting of copies of the original query in which the
    variables are instantiated with values supplied by the stream of
    frames, and this final stream is printed at the terminal:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_1_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define input-prompt ";;; Query input:")
        (define output-prompt ";;; Query results:")

        
        (define (query-driver-loop)
        (prompt-for-input input-prompt)
        (let ((q (query-syntax-process (read))))
        (cond ((assertion-to-be-added? q)
              (add-rule-or-assertion! (add-assertion-body q))
              (newline)
              (display "Assertion added to data base.")
              (query-driver-loop))
              (else
              (newline)
              (display output-prompt)
              (display-stream
              (stream-map
              (lambda (frame)
              (instantiate q
              frame
              (lambda (v f)
              (contract-question-mark v))))
              (qeval q (singleton-stream '()))))
              (query-driver-loop)))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_1_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
const input_prompt = "// Query input:";
const output_prompt = "// Query results:";

function query_driver_loop() {
    const input = prompt(input_prompt);
    const q = query_syntax_process(parse(input));
    if (assertion_to_be_added(q)) {
        add_rule_or_assertion(add_assertion_body(q));
        display("Assertion added to data base.");
    } else {
        display(output_prompt);
        display_stream(
            stream_map(
                frame =>
                    instantiate(q, frame,
                                (v, f) =>
                                   contract_question_mark(v)),
                qeval(q, singleton_stream(null))));
        
    }
    query_driver_loop();
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p3' class='permalink'></a><p>
    
    Here, as in the other evaluators in this chapter, we use an abstract
    syntax for the expressions of the query language.
    The implementation of the expression syntax, including the predicate
  
    <span style="color:teal">
      <kbd>assertion-to-be-added?</kbd>
    </span>
    <span style="color:blue">
      <kbd>assertion_to_be_added</kbd>
    </span>
  
  and the selector
  
    <span style="color:teal">
      <kbd>add-assertion-body</kbd>,
    </span>
    <span style="color:blue">
      <kbd>add_assertion_body</kbd>,
    </span>
  
  is given in section <REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>.
  
    <span style="color:teal">
      <kbd>Add\?rule\?or-assertion!</kbd>
    </span>
    <span style="color:blue">
      The function <kbd>add_rule_or_assertion</kbd>
    </span>
  
  is defined in section <REF NAME="sec:query-db"><a class="superscript" id="4.4.4-sec-link-4.4.4.5" href="./4.4.4.html#sec4.4.4.5">4.4.4.5</a></REF>.
  </p></div>

  <div class='permalink'>
<a name='p4' class='permalink'></a><p>
    Before doing any processing on an input expression, the driver loop
    transforms it syntactically into a form that makes the processing more
    efficient.  This involves changing the 
    
    
    representation of pattern
    variables.  When the query is instantiated, any variables that remain
    unbound are transformed back to the input representation before being
    printed.  These transformations are performed by the two
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
  
    <span style="color:teal">
      <kbd>query-syntax\?process</kbd>
    </span>
    <span style="color:blue">
      <kbd>query_syntax_process</kbd>
    </span>
  
  and
  
    <span style="color:teal">
      <kbd>contract-question-mark</kbd>
    </span>
    <span style="color:blue">
      <kbd>contract_question_mark</kbd>
    </span>
  
   (section <REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>).
  </p></div>

  <div class='permalink'>
<a name='p5' class='permalink'></a><p>
    
    To instantiate an expression, we copy it, replacing any variables in
    the expression by their values in a given frame.  The values are
    themselves instantiated, since they could contain variables (for
    example, if
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    in <kbd>exp</kbd> is bound to
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    as the result
    of unification and
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    is in turn bound to 5).  The action to
    take if a variable cannot be instantiated is given by a procedural
    argument to <kbd>instantiate</kbd>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_2_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (instantiate exp frame unbound-var-handler)
        (define (copy exp)
        (cond ((var? exp)
              (let ((binding (binding-in-frame exp frame)))
              (if binding
              (copy (binding-value binding))
              (unbound-var-handler exp frame))))
              ((pair? exp)
              (cons (copy (car exp)) (copy (cdr exp))))
              (else exp)))
        (copy exp))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_2_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function instantiate(exp, frame, unbound_var_handler) {
    function copy(exp) {
        if (is_var(exp)) {
            const binding = binding_in_frame(exp, frame);
            if (! binding === undefined) {
                return unbound_var_handler(exp, frame);
     	    } else {
 	        return copy(binding_value(binding));
            }
	} else if (is_pair(exp)) {
            return pair(copy(head(exp)), copy(tail(exp)));
        } else {
            return exp;
	}
    }
    copy(exp);
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p6' class='permalink'></a><p>
    The
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    that manipulate bindings are defined in
    section <REF NAME="sec:query-bindings"><a class="superscript" id="4.4.4-sec-link-4.4.4.8" href="./4.4.4.html#sec4.4.4.8">4.4.4.8</a></REF>.
    
    
  </p></div>
      

      
      <div class='permalink'>
        <a name='sec4.4.4.2' class='permalink'></a><h1>
    4.4.4.2 The Evaluator</h1></div>
  

  <div class='permalink'>
<a name='p7' class='permalink'></a><p>
    
    The <kbd>qeval</kbd>
    <span style="color:teal">procedure</span><span style="color:blue">function</span>,
    called by the
  
    <span style="color:teal">
      <kbd>query-driver-loop</kbd>,
    </span>
    <span style="color:blue">
      <kbd>query_driver_loop</kbd>,
    </span>
  
    is the basic evaluator of the query system.  It takes as inputs a query
    and a stream of frames, and it returns a stream of extended frames.
    It identifies special forms by a 
    
    data-directed dispatch using <kbd>get</kbd> and <kbd>put</kbd>, just as we did in implementing generic operations
    in chapter 2.  Any query that is not identified as a special form is
    assumed to be a simple query, to be processed by
  
    <span style="color:teal">
      <kbd>simple-query</kbd>.
    </span>
    <span style="color:blue">
      <kbd>simple_query</kbd>.
    </span>
  
    

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_3_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (qeval query frame-stream)
        (let ((qproc (get (type query) 'qeval)))
        (if qproc
              (qproc (contents query) frame-stream)
              (simple-query query frame-stream))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_3_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function qeval(query, frame_stream) {	
    const qfun = get(type(query), "qeval");
    return qfun === undefined
        ? simple_query(query, frame_stream)
        : qfun(contents(query), frame_stream);
}
</pre></div></div></td></tr></table>

    <span style="color:teal"><kbd>Type</kbd></span>
    <span style="color:blue">The functions <kbd>type</kbd></span> and <kbd>contents</kbd>, defined in section <REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>,
    implement the abstract syntax of the
    <span style="color:teal">special forms</span><span style="color:blue">expressions</span>.
  </p></div>

  
      <div class='permalink'>
        <a name='h3' class='permalink'></a><h2>
    
    Simple queries
  </h2></div>

  
  <div class='permalink'>
<a name='p8' class='permalink'></a><p>
    The
  
    <span style="color:teal">
      <kbd>simple-query</kbd>
    </span>
    <span style="color:blue">
      <kbd>simple_query</kbd>
    </span>
  
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    handles simple queries.  It takes as
    arguments a simple query (a pattern) together with a stream of frames,
    and it returns the stream formed by extending each frame by all
    data-base matches of the query.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_4_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (simple-query query-pattern frame-stream)
        (stream-flatmap
        (lambda (frame)
        (stream-append-delayed
        (find-assertions query-pattern frame)
        (delay (apply-rules query-pattern frame))))
        frame-stream))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_4_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function simple_query(query_pattern, frame_stream) {	
    return stream_flatmap(
        frame => 
            stream_append_delayed(find_assertions(query_pattern, frame),
                                  delay(apply_rules(query_pattern, frame))),
        frame_stream);
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p9' class='permalink'></a><p>
    For each frame in the input stream, we use
  
    <span style="color:teal">
      <kbd>find-assertions</kbd>
    </span>
    <span style="color:blue">
      <kbd>find_assertions</kbd>
    </span>
  
    (section <REF NAME="sec:query-match"><a class="superscript" id="4.4.4-sec-link-4.4.4.3" href="./4.4.4.html#sec4.4.4.3">4.4.4.3</a></REF>) to match the pattern against all
    assertions in the data base, producing a stream of extended frames,
    and we use
  
    <span style="color:teal">
      <kbd>apply-rules</kbd>
    </span>
    <span style="color:blue">
      <kbd>apply_rules</kbd>
    </span>
  
    (section <REF NAME="sec:query-unify"><a class="superscript" id="4.4.4-sec-link-4.4.4.4" href="./4.4.4.html#sec4.4.4.4">4.4.4.4</a></REF>) to apply
    all possible rules, producing another stream of extended frames.
    These two streams are combined (using
  
    <span style="color:teal">
      <kbd>stream\?append\?delayed</kbd>,
    </span>
    <span style="color:blue">
      <kbd>stream_append_delayed</kbd>,
    </span>
  
    section <REF NAME="sec:query-streams"><a class="superscript" id="4.4.4-sec-link-4.4.4.6" href="./4.4.4.html#sec4.4.4.6">4.4.4.6</a></REF>) to make a stream of all the ways that
    the given pattern can be satisfied consistent with the original frame
    (see exercise <REF NAME="ex:q-why-not-append"><a class="superscript" id="4.4.4-ex-link-4.88" href="./4.4.4.html#ex_4.88">4.88</a></REF>).  The streams for the
    individual input frames are combined using
  
    <span style="color:teal">
      <kbd>stream-flatmap</kbd>
    </span>
    <span style="color:blue">
      <kbd>stream_flatmap</kbd>
    </span>
  
    (section <REF NAME="sec:query-streams"><a class="superscript" id="4.4.4-sec-link-4.4.4.6" href="./4.4.4.html#sec4.4.4.6">4.4.4.6</a></REF>) to form one large stream of all the
    ways that any of the frames in the original input stream can be
    extended to produce a match with the given pattern.
    
  </p></div>

  
      <div class='permalink'>
        <a name='h4' class='permalink'></a><h2>
    
    Compound queries
  </h2></div>

  
  <div class='permalink'>
<a name='p10' class='permalink'></a><p>
    
    <kbd>And</kbd> queries are handled as illustrated in
    figure <REF NAME="fig:query-and"><a class="superscript" id="4.4.4-fig-link-4.7" href="./4.4.2.html#fig_4.7">4.7</a></REF> by the <kbd>conjoin</kbd>
    <span style="color:teal">procedure. <kbd>Conjoin</kbd></span>
    <span style="color:blue">function, which</span> takes as inputs the conjuncts and the frame stream and
    returns the stream of extended frames.  First, <kbd>conjoin</kbd> processes
    the stream of frames to find the stream of all possible frame extensions
    that satisfy the first query in the conjunction.  Then, using this as the new
    frame stream, it recursively applies <kbd>conjoin</kbd> to the rest of the
    queries.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_5_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (conjoin conjuncts frame-stream)
        (if (empty-conjunction? conjuncts)
        frame-stream
        (conjoin (rest-conjuncts conjuncts)
              (qeval (first-conjunct conjuncts)
              frame-stream))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_5_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function conjoin(conjuncts, frame_stream) {	
    return is_empty_conjunction(conjuncts)
        ? frame_stream
        : conjoin(rest_conjuncts(conjuncts),
                  qeval(first_conjunct(conjuncts),
	                frame_stream));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p11' class='permalink'></a><p>
    The expression
    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_6_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(put 'and 'qeval conjoin)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_6_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
put("and", "qeval", conjoin);
</pre></div></div></td></tr></table>
    sets up <kbd>qeval</kbd> to dispatch to <kbd>conjoin</kbd> when an <kbd>and</kbd>
    <span style="color:teal">form</span><span style="color:blue">expression</span> is encountered.
  </p></div>

  <div class='permalink'>
<a name='p12' class='permalink'></a><p>
    
    <kbd>Or</kbd> queries are handled similarly, as shown in
    figure <REF NAME="fig:query-or"><a class="superscript" id="4.4.4-fig-link-4.8" href="./4.4.2.html#fig_4.8">4.8</a></REF>.  The output streams for the various
    disjuncts of the <kbd>or</kbd> are computed separately and merged using the
  
    <span style="color:teal">
      <kbd>interleave-delayed</kbd>
    </span>
    <span style="color:blue">
      <kbd>interleave_delayed</kbd>
    </span>
  
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    from section <REF NAME="sec:query-streams"><a class="superscript" id="4.4.4-sec-link-4.4.4.6" href="./4.4.4.html#sec4.4.4.6">4.4.4.6</a></REF>.
    (See exercises <REF NAME="ex:q-why-not-append"><a class="superscript" id="4.4.4-ex-link-4.88" href="./4.4.4.html#ex_4.88">4.88</a></REF> and <REF NAME="ex:q-why-interleave"><a class="superscript" id="4.4.4-ex-link-4.89" href="./4.4.4.html#ex_4.89">4.89</a></REF>.)

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_7_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (disjoin disjuncts frame-stream)
        (if (empty-disjunction? disjuncts)
        the-empty-stream
        (interleave-delayed
        (qeval (first-disjunct disjuncts) frame-stream)
        (delay (disjoin (rest-disjuncts disjuncts)
              frame-stream)))))

        (put 'or 'qeval disjoin)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_7_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function disjoin(disjuncts, frame_stream) {
    return is_empty_disjunction(disjuncts)
        ? null
        : interleave_delayed(
              qeval(first_disjunct(disjuncts), frame_stream),
	      delay(disjoin(rest_disjuncts(disjuncts),
	                    frame_stream)));
}
put("or", "qeval", disjoin);
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p13' class='permalink'></a><p>
    The predicates and selectors for the syntax of conjuncts and disjuncts
    are given in section <REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>.
  </p></div>

  
      <div class='permalink'>
        <a name='h5' class='permalink'></a><h2>
    
    Filters
  </h2></div>

  <div class='permalink'>
<a name='p14' class='permalink'></a><p>
    
    <kbd>Not</kbd> is handled by the method outlined in
    section <REF NAME="sec:how-query-works"><a class="superscript" id="4.4.4-sec-link-4.4.2" href="./4.4.2.html">4.4.2</a></REF>.  We attempt to extend each frame in
    the input stream to satisfy the query being negated, and we include a
    given frame in the output stream only if it cannot be extended.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_8_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (negate operands frame-stream)
        (stream-flatmap
        (lambda (frame)
        (if (stream-null? (qeval (negated-query operands)
              (singleton-stream frame)))
              (singleton-stream frame)
              the-empty-stream))
        frame-stream))

        (put 'not 'qeval negate)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_8_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function negate(operands, frame_stream) {
    return stream_flatmap(
              frame =>
	         is_null(qeval(negated_query(operands),
                               singleton_stream(frame)))
	         ? singleton_stream(frame)
		 : null,
	      frame_stream);
}
put("not", "qeval", negate);
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p15' class='permalink'></a><p>
    
    <span style="color:teal"><kbd>Lisp-value</kbd></span><span style="color:blue"><kbd>Javascript_value</kbd></span> is a filter similar to <kbd>not</kbd>.  Each frame in the
    stream is used to instantiate the variables in the pattern, the
    indicated predicate is applied, and the frames for which the predicate
    returns false are filtered out of the input stream.  An error results
    if there are unbound pattern variables.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_9_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (lisp-value call frame-stream)
        (stream-flatmap
        (lambda (frame)
        (if (execute
              (instantiate
              call
              frame
              (lambda (v f)
              (error "Unknown pat var - - LISP-VALUE" v))))
              (singleton-stream frame)
              the-empty-stream))
        frame-stream))

        (put 'lisp-value 'qeval lisp-value)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_9_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function javascript_value(call, frame_stream) {
    return stream_flatmap(
              frame =>
                 execute(instantiate(call, frame,
                            (v, f) =>
                                error(v, "Unknown pat var --- javascript_value")))
                 ? singleton_stream(frame)
                 : null,
              frame_stream);
}
put("javascript_value", "qeval", javascript_value);
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p16' class='permalink'></a><p>
    <span style="color:teal"><kbd>Execute</kbd></span><span style="color:blue">The function <kbd>execute</kbd></span>, which applies the predicate to the arguments, must
    <span style="color:teal"><kbd>eval</kbd></span>
    <span style="color:blue"><kbd>evaluate</kbd></span> the predicate expression to get the
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    to apply.
    However, it must not evaluate the arguments, since they are already
    the actual arguments, not expressions whose evaluation (in <span style="color:teal">Lisp</span><span style="color:blue">JavaScript</span>) will
    produce the arguments.  Note that <kbd>execute</kbd> is implemented using
    
    <span style="color:teal"><kbd>eval</kbd></span>
    <span style="color:blue"><kbd>evaluate</kbd></span> and <kbd>apply</kbd> from the underlying <span style="color:teal">Lisp</span><span style="color:blue">JavaScript</span> system.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_10_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (execute exp)
        (apply (eval (predicate exp) user-initial-environment)
              (args exp)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_10_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function execute(exp) {	
    return apply(evaluate(predicate(exp), user_initial_environment),
                 args(exp));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p17' class='permalink'></a><p>
    The
    <span style="color:teal"><kbd>always-true</kbd> special form</span>
    <span style="color:blue"><kbd>always_true</kbd> expression</span> provides for a query that is always
    satisfied.  It ignores its contents (normally empty) and simply passes
    through all the frames in the input stream.
    <span style="color:teal"><kbd>Always-true</kbd></span>
    <span style="color:blue">The <kbd>always_true</kbd> expression</span>
    is used
    by the
    <span style="color:teal"><kbd>rule-body</kbd></span>
    <span style="color:blue"><kbd>rule_body</kbd></span>
    selector (section 7<REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>)
    
    to provide bodies for rules that were
    defined without bodies (that is, rules whose bodies are always
    satisfied).

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_11_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (always-true ignore frame-stream) frame-stream)

        (put 'always-true 'qeval always-true)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_11_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function always_true(ignore, frame_stream) {	
    return frame_stream;
}
put("always_true", "qeval", always_true);
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p18' class='permalink'></a><p>
    The selectors that define the syntax of <kbd>not</kbd> and
    <span style="color:teal"><kbd>lisp-value</kbd></span>
    <span style="color:blue"><kbd>javascript_value</kbd></span>
    are given in section <REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>.
    
    
  </p></div>
      

      
      <div class='permalink'>
        <a name='sec4.4.4.3' class='permalink'></a><h1>
    4.4.4.3 Finding Assertions by Pattern Matching</h1></div>
  
      
  <div class='permalink'>
<a name='p19' class='permalink'></a><p>
    
    
    
      <span style="color:teal"><kbd>Find-assertions</kbd>,
      </span>
      <span style="color:blue">The function <kbd>find_assertions</kbd>,
      </span>
    
    called by
    
      <span style="color:teal"><kbd>simple-query</kbd>
      </span>
      <span style="color:blue"><kbd>simple_query</kbd>
      </span>
    
    (section <REF NAME="sec:query-eval"><a class="superscript" id="4.4.4-sec-link-4.4.4.2" href="./4.4.4.html#sec4.4.4.2">4.4.4.2</a></REF>), takes as input a pattern and a frame.
    It returns a stream of frames, each extending the given one by a
    data-base match of the given pattern.  It uses
    
      <span style="color:teal"><kbd>fetch-assertions</kbd>
      </span>
      <span style="color:blue"><kbd>fetch_assertions</kbd>
      </span>
    
    (section <REF NAME="sec:query-db"><a class="superscript" id="4.4.4-sec-link-4.4.4.5" href="./4.4.4.html#sec4.4.4.5">4.4.4.5</a></REF>) to get a stream of all the assertions in
    the data base that should be checked for a match against the pattern
    and the frame.  The reason for
    
      <span style="color:teal"><kbd>fetch-assertions</kbd>
      </span>
      <span style="color:blue"><kbd>fetch_assertions</kbd>
      </span>
    
    here is that we
    can often apply simple tests that will eliminate many of the entries
    in the data base from the pool of candidates for a successful match.
    The system would still work if we eliminated
    
      <span style="color:teal"><kbd>fetch-assertions</kbd>
      </span>
      <span style="color:blue"><kbd>fetch_assertions</kbd>
      </span>
    
    and simply checked a stream of all assertions in the data base, but
    the computation would be less efficient because we would need to make
    many more calls to the matcher.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_12_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (find-assertions pattern frame)
        (stream-flatmap (lambda (datum)
              (check-an-assertion datum pattern frame))
              (fetch-assertions pattern frame)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_12_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function find_assertions(pattern, frame) {	
    return stream_flatmap(
              datum =>
                 check_an_assertion(datum, pattern, frame),
              fetch_assertions(pattern, frame));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p20' class='permalink'></a><p>
    
      <span style="color:teal"><kbd>Check-an-assertion</kbd>
      </span>
      <span style="color:blue">The function <kbd>check_an_assertion</kbd>
      </span>
    
    takes as arguments a pattern, a data object
    (assertion), and a frame and returns either a one-element stream
    containing the extended frame or
    
      <span style="color:teal"><kbd>the-empty-stream</kbd>
      </span>
      <span style="color:blue"><kbd>null</kbd>
      </span>
    
    if the match fails.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_13_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (check-an-assertion assertion query-pat query-frame)
        (let ((match-result
              (pattern-match query-pat assertion query-frame)))
        (if (eq? match-result 'failed)
              the-empty-stream
              (singleton-stream match-result))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_13_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function check_an_assertion(assertion, query_pat, query_frame) {
    const match_result = pattern_match(query_pat, assertion, 
                                       query_frame);
    return match_result === "failed"
        ? null
        : singleton_stream(match_result);
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p21' class='permalink'></a><p>
    The basic pattern matcher returns either the
    
      <span style="color:teal">symbol <kbd>failed</kbd></span>
      <span style="color:blue">string <kbd>"failed"</kbd></span>
    
    or an
    extension of the given frame.  The basic idea of the matcher is to
    check the pattern against the data, element by element, accumulating
    bindings for the pattern variables.  If the pattern and the data
    object are the same, the match succeeds and we return the frame of
    bindings accumulated so far.  Otherwise, if the pattern is a variable
    we extend the current frame by binding the variable to the data, so
    long as this is consistent with the bindings already in the frame.  If
    the pattern and the data are both pairs, we (recursively) match the
    <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> of the pattern against the <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> of the data to produce
    a frame; in this frame we then match the <span style="color:teal"><kbd>cdr</kbd></span><span style="color:blue"><kbd>tail</kbd></span> of the pattern
    against the <span style="color:teal"><kbd>cdr</kbd></span><span style="color:blue"><kbd>tail</kbd></span> of the data.  If none of these cases are
    applicable, the match fails and we return the symbol <kbd>failed</kbd>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_14_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (pattern-match pat dat frame)
        (cond ((eq? frame 'failed) 'failed)
              ((equal? pat dat) frame)
              ((var? pat) (extend-if-consistent pat dat frame))
              ((and (pair? pat) (pair? dat))
              (pattern-match (cdr pat)
              (cdr dat)
              (pattern-match (car pat)
              (car dat)
              frame)))
              (else 'failed)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_14_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function pattern_match(pat, dat, frame) {
    return frame === "failed" 
        ? "failed"
        : equal(pat, dat) 
        ? frame   
        : is_var(pat) 
        ? extend_if_consistent(pat, dat, frame)
        : is_pair(pat) && is_pair(dat)
        ? pattern_match(tail(pat),
                        tail(dat),
                        pattern_match(head(pat),
                                      head(dat),
                                      frame))
        : "failed";
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p22' class='permalink'></a><p>
    Here is the
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    that extends a frame by adding a new binding, if
    this is consistent with the bindings already in the frame:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_15_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (extend-if-consistent var dat frame)
        (let ((binding (binding-in-frame var frame)))
        (if binding
              (pattern-match (binding-value binding) dat frame)
              (extend var dat frame))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_15_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function extend_if_consistent(variable, dat, frame) {
    const binding = binding_in_frame(variable, frame);
    return binding !== undefined
        ? extend(variable, dat, frame)
        : pattern_match(binding_value(binding), dat, frame);
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p23' class='permalink'></a><p>
    If there is no binding for the variable in the frame, we simply add
    the binding of the variable to the data.  Otherwise we match, in the
    frame, the data against the value of the variable in the frame.  If
    the stored value contains only constants, as it must if it was stored
    during pattern matching by
    <span style="color:teal"><kbd>extend-if-consistent</kbd></span><span style="color:blue"><kbd>extend_if_consistent</kbd></span>,
    then the match
    simply tests whether the stored and new values are the same.  If so,
    it returns the unmodified frame; if not, it returns a failure
    indication.  The stored value may, however, contain pattern variables
    if it was stored during unification (see section <REF NAME="sec:query-unify"><a class="superscript" id="4.4.4-sec-link-4.4.4.4" href="./4.4.4.html#sec4.4.4.4">4.4.4.4</a></REF>).
    The recursive match of the stored pattern against the new data will add or
    check bindings for the variables in this pattern.  For example,
    suppose we have a frame in which
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    is bound to <span style="color:teal"><kbd>(f ?y)</kbd></span><span style="color:blue"><kbd>list("f", y)</kbd></span> and
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    is unbound, and we wish to augment this frame by a binding of
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    to
    <span style="color:teal"><kbd>(f b)</kbd></span><span style="color:blue"><kbd>list("f", "b")</kbd></span>.  We look up
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    and find that it is bound to
    <span style="color:teal"><kbd>(f ?y)</kbd></span><span style="color:blue"><kbd>list("f", y)</kbd></span>.  This leads us to match
    <span style="color:teal"><kbd>(f ?y)</kbd></span><span style="color:blue"><kbd>list("f", y)</kbd></span> against
    the proposed new value
    <span style="color:teal"><kbd>(f b)</kbd></span><span style="color:blue"><kbd>list("f", "b")</kbd></span>
    in the same frame.  Eventually
    this match extends the frame by adding a binding of
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    to
    <span style="color:teal"><kbd>b</kbd></span><span style="color:blue"><kbd>"b"</kbd></span>.
    <span style="color:teal"><kbd>?X</kbd></span><span style="color:blue">The variable <kbd>x</kbd></span>
    remains bound to <span style="color:teal"><kbd>(f ?y)</kbd></span><span style="color:blue"><kbd>list("f", y)</kbd></span>.  We never modify a stored
    binding and we never store more than one binding for a given variable.
  </p></div>

  <div class='permalink'>
<a name='p24' class='permalink'></a><p>
    The
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    used by
    <span style="color:teal"><kbd>extend-if-consistent</kbd></span><span style="color:blue"><kbd>extend_if_consistent</kbd></span>
    to manipulate
    bindings are defined in section <REF NAME="sec:query-bindings"><a class="superscript" id="4.4.4-sec-link-4.4.4.8" href="./4.4.4.html#sec4.4.4.8">4.4.4.8</a></REF>.
  </p></div>

  
      

      
      <div class='permalink'>
        <a name='sec4.4.4.4' class='permalink'></a><h1>
    4.4.4.4 Rules and Unification</h1></div>
  
      
  <div class='permalink'>
<a name='p25' class='permalink'></a><p>
    
    <span style="color:teal"><kbd>Apply-rules</kbd></span><span style="color:blue">The function <kbd>apply_rules</kbd></span>
    is the rule analog of
    <span style="color:teal"><kbd>find-assertions</kbd></span><span style="color:blue"><kbd>find_assertions</kbd></span>
    (section <REF NAME="sec:query-match"><a class="superscript" id="4.4.4-sec-link-4.4.4.3" href="./4.4.4.html#sec4.4.4.3">4.4.4.3</a></REF>).  It
    takes as input a pattern and a frame, and it forms a stream of
    extension frames by applying rules from the data base.
    <span style="color:teal"><kbd>Stream-flatmap</kbd></span><span style="color:blue">The function <kbd>stream_flatmap</kbd></span>
    maps
    <span style="color:teal"><kbd>apply-a-rule</kbd></span><span style="color:blue"><kbd>apply_a_rule</kbd></span>
    down the stream of possibly
    applicable rules (selected by
    <span style="color:teal"><kbd>fetch-rules</kbd></span><span style="color:blue"><kbd>fetch_rules</kbd></span>,
    section <REF NAME="sec:query-db"><a class="superscript" id="4.4.4-sec-link-4.4.4.5" href="./4.4.4.html#sec4.4.4.5">4.4.4.5</a></REF>)
    and combines the resulting streams of frames.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_16_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (apply-rules pattern frame)
        (stream-flatmap (lambda (rule)
              (apply-a-rule rule pattern frame))
              (fetch-rules pattern frame)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_16_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function apply_rules(pattern, frame) {	
    return stream_flatmap(
              rule => 
                 apply_a_rule(rule, pattern, frame),
              fetch_rules(pattern, frame));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p26' class='permalink'></a><p>
    <span style="color:teal"><kbd>Apply-a-rule</kbd></span><span style="color:blue">The function <kbd>apply_a_rule</kbd></span>
    applies rules using the method outlined in
    section <REF NAME="sec:how-query-works"><a class="superscript" id="4.4.4-sec-link-4.4.2" href="./4.4.2.html">4.4.2</a></REF>.  It first augments its argument
    frame by unifying the rule conclusion with the pattern in the given
    frame.  If this succeeds, it evaluates the rule body in this new frame.
  </p></div>

  <div class='permalink'>
<a name='p27' class='permalink'></a><p>
    Before any of this happens, however, the program renames all the
    variables in the rule with unique new names.  The reason for this is
    to prevent the variables for different rule applications from becoming
    confused with each other.  For instance, if two rules both use a
    variable named
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>,
    then each one may add a binding for
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    to the frame when it is applied.  These two
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>'s
    have nothing to
    do with each other, and we should not be fooled into thinking that the
    two bindings must be consistent.  Rather than rename variables, we
    could devise a more clever environment structure; however, the
    renaming approach we have chosen here is the most straightforward,
    even if not the most efficient.  (See
    exercise <REF NAME="ex:query-local-names"><a class="superscript" id="4.4.4-ex-link-4.96" href="./4.4.4.html#ex_4.96">4.96</a></REF>.)  Here is the
    <span style="color:teal"><kbd>apply-a-rule</kbd></span><span style="color:blue"><kbd>apply_a_rule</kbd></span>
    <span style="color:teal">procedure</span><span style="color:blue">function</span>:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_17_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (apply-a-rule rule query-pattern query-frame)
        (let ((clean-rule (rename-variables-in rule)))
        (let ((unify-result
              (unify-match query-pattern
              (conclusion clean-rule)
              query-frame)))
        (if (eq? unify-result 'failed)
              the-empty-stream
              (qeval (rule-body clean-rule)
              (singleton-stream unify-result))))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_17_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function apply_a_rule(rule, query_pattern, query_frame) {
    const clean_rule = rename_variables_in(rule);
    const unify_result = 
             unify_match(query_pattern,
                         conclusion(clean_rule),
                         query_frame);
    return unify_result === "failed"
        ? null
        : qeval(rule_body(clean_rule),
                singleton_stream(unify_result));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p28' class='permalink'></a><p>
    The selectors
    <span style="color:teal"><kbd>rule-body</kbd></span><span style="color:blue"><kbd>rule_body</kbd></span>
    and <kbd>conclusion</kbd> that extract parts
    of a rule are defined in section 7<REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>.
  </p></div>

  <div class='permalink'>
<a name='p29' class='permalink'></a><p>
    We generate unique variable names by associating a unique identifier
    (such as a number) with each rule application and combining this
    identifier with the original variable names.  For example, if the
    rule-application identifier is 7, we might change each
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    in
    the rule to
    <span style="color:teal"><kbd>?x-7</kbd></span><span style="color:blue"><kbd>x_7</kbd></span>
    and each
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    in the rule to
    <span style="color:teal"><kbd>?y-7</kbd></span><span style="color:blue"><kbd>y_7</kbd></span>.
    (<span style="color:teal"><kbd>Make-new-variable</kbd></span><span style="color:blue">The functions <kbd>make_new_variable</kbd></span> and
    <span style="color:teal"><kbd>new-rule-application\?id</kbd></span><span style="color:blue"><kbd>new_rule_application_id</kbd></span>
    are included with the syntax
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    in section <REF NAME="sec:query-syntax"><a class="superscript" id="4.4.4-sec-link-4.4.4.7" href="./4.4.4.html#sec4.4.4.7">4.4.4.7</a></REF>.)

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_18_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (rename-variables-in rule)
        (let ((rule-application-id (new-rule-application-id)))
        (define (tree-walk exp)
        (cond ((var? exp)
              (make-new-variable exp rule-application-id))
              ((pair? exp)
              (cons (tree-walk (car exp))
              (tree-walk (cdr exp))))
              (else exp)))
        (tree-walk rule)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_18_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function rename_variables_in(rule) {
    const rule_application_id = new_rule_application_id();
    function tree_walk(exp) {
        return is_var(exp) 
            ? make_new_variable(exp, rule_application_id)
            : is_pair(exp)
            ? pair(tree_walk(head(exp)),
                   tree_walk(tail(exp)))
            : exp;
    }
    tree_walk(rule);
}
</pre></div></div></td></tr></table>
    
  </p></div>

  <div class='permalink'>
<a name='p30' class='permalink'></a><p>
    
    
    The unification algorithm is implemented as a
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    that takes as
    inputs two patterns and a frame and returns either the extended frame
    or the
    <span style="color:teal">symbol <kbd>failed</kbd></span><span style="color:blue">string <kbd>"failed"</kbd></span>.
    The unifier is like the pattern matcher except that it is
    symmetrical—variables are allowed on both sides of the match.
    <span style="color:teal"><kbd>Unify-match</kbd></span><span style="color:blue">The function <kbd>unify_match</kbd></span>
    is basically the same as
    <span style="color:teal"><kbd>pattern-match</kbd></span><span style="color:blue"><kbd>pattern_match</kbd></span>,
    except that there is extra code (marked <QUOTE><kbd>***</kbd></QUOTE> below) to handle
    the case where the object on the right side of the match is a variable.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_19_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (unify-match p1 p2 frame)
        (cond ((eq? frame 'failed) 'failed)
              ((equal? p1 p2) frame)
              ((var? p1) (extend-if-possible p1 p2 frame))
              ((var? p2) (extend-if-possible p2 p1 frame))  
              ((and (pair? p1) (pair? p2))
              (unify-match (cdr p1)
              (cdr p2)
              (unify-match (car p1)
              (car p2)
              frame)))
              (else 'failed)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_19_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function unify_match(p1, p2, frame) {
    return frame === "failed"
        ? "failed"
        : equal(p1, p2)
        ? frame
        : is_var(p1) 
        ? extend_if_possible(p1, p2, frame)
        : is_var(p2) 
        ? extend_if_possible(p2, p1, frame)  // ***
        : pair(p1) && pair(p2)
        ? unify_match(tail(p1),
                      tail(p2),
                      unify_match(head(p1),
                                  head(p2),
                                  frame))
        : "failed";
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p31' class='permalink'></a><p>
    In unification, as in one-sided pattern matching, we want to accept a
    proposed extension of the frame only if it is consistent with existing
    bindings.  The
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    <span style="color:teal"><kbd>extend-if-possible</kbd></span><span style="color:blue"><kbd>extend_if_possible</kbd></span>
    used in unification
    is the same as the
    <span style="color:teal"><kbd>extend-if-consistent</kbd></span><span style="color:blue"><kbd>extend_if_consistent</kbd></span>
    used in pattern matching
    except for two special checks, marked
    <QUOTE><kbd>***</kbd></QUOTE> in the program
    below.  In the first case, if the variable we are trying to match is
    not bound, but the value we are trying to match it with
    is itself a (different) variable, it is
    necessary to check to see if the value is bound, and if so, to match
    its value.  If both parties to the match are unbound, we may bind
    either to the other.
  </p></div>

  <div class='permalink'>
<a name='p32' class='permalink'></a><p>
    The second check deals with attempts to bind a variable to a pattern
    that includes that variable.  Such a situation can occur whenever a
    variable is repeated in both patterns.  Consider, for example,
    unifying the two patterns
    <span style="color:teal"><kbd>(?x ?x)</kbd></span><span style="color:blue"><kbd>list(x, x)</kbd></span>
    and
    <span style="color:teal"><kbd>(?y ^expression involving^ ?y)</kbd></span><span style="color:blue"><kbd>list(y,</kbd> $\textit{expression involving}$ <kbd>y)</kbd></span>
    in a frame where both
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    and
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    are unbound.  First
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    is matched
    against
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>,
    making a binding of
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    to
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>.
    Next, the same
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    is matched against the given expression
    involving
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>.
    Since
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    is already bound to
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>,
    this results in matching
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    against the expression. If we think of the
    unifier as finding a set of values for the pattern variables that make
    the patterns the same, then these patterns imply instructions to find a
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    such that
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    is equal to the
    <span style="color:teal"><kbd>^expression involving^ ?y</kbd></span><span style="color:blue">$\textit{expression involving}$<kbd>y</kbd></span>.
    There is no general method for solving such
    equations, so we reject such bindings; these cases are recognized by
    the predicate 
    <span style="color:teal"><kbd>depends-on?</kbd></span><span style="color:blue"><kbd>depends_on</kbd></span>.<a class='superscript' id='footnote-link-1' href='#footnote-1'>[1]</a>
    On the other hand, we do not want to reject attempts
    to bind a variable to itself.  For example, consider unifying
    <span style="color:teal"><kbd>(?x~?x)</kbd></span><span style="color:blue"><kbd>list(x, x)</kbd></span>
    and <span style="color:teal"><kbd>(?y~?y)</kbd></span><span style="color:blue"><kbd>list(y, y)</kbd></span>.  The second attempt to bind
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>
    to
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    matches
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    (the stored value of
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>)
    against
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    (the new value of
    <span style="color:teal"><kbd>?x</kbd></span><span style="color:blue"><kbd>x</kbd></span>).  This is taken care of by the
    <span style="color:teal"><kbd>equal?</kbd></span><span style="color:blue"><kbd>equal</kbd></span>
    clause of
    <span style="color:teal"><kbd>unify-match</kbd></span><span style="color:blue"><kbd>unify_match</kbd></span>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_20_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (extend-if-possible var val frame)
        (let ((binding (binding-in-frame var frame)))
        (cond (binding
              (unify-match
              (binding-value binding) val frame))
              ((var? val)                      
              (let ((binding (binding-in-frame val frame)))
              (if binding
              (unify-match
              var (binding-value binding) frame)
              (extend var val frame))))
              ((depends-on? val var frame)     
              'failed)
              (else (extend var val frame)))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_20_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function extend_if_possible(variable, val, frame) {
    const binding = binding_in_frame(variable, frame);
    if (binding !== undefined) {
        return unify_match(binding_value(binding), 
                            val, frame); 
    } else if (is_var(val)) {                      // ***
        const binding = binding_in_frame(val, frame);
        return binding !== undefined
            ? unify_match(variable,
                          binding_value(binding),
			  frame)
            : extend(variable, val, frame);
    } else if (depends_on(val, variable, frame)) { // ***
        return "failed";
    } else {
        return extend(variable, val, frame);
    }
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p33' class='permalink'></a><p>
    <span style="color:teal"><kbd>Depends-on?</kbd></span><span style="color:blue">The function <kbd>depends_on</kbd></span>
    is a predicate that tests whether an expression
    proposed to be the value of a pattern variable depends on the variable.
    This must be done relative to the current frame because the expression
    may contain occurrences of a variable that already has a value that
    depends on our test variable.  The structure of
    <span style="color:teal"><kbd>depends-on?</kbd></span><span style="color:blue"><kbd>depends_on</kbd></span>
    is a simple recursive tree walk in which we substitute for the values of
    variables whenever necessary.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_21_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (depends-on? exp var frame)
        (define (tree-walk e)
        (cond ((var? e)
              (if (equal? var e)
              true
              (let ((b (binding-in-frame e frame)))
              (if b
              (tree-walk (binding-value b))
              false))))
              ((pair? e)
              (or (tree-walk (car e))
              (tree-walk (cdr e))))
              (else false)))
        (tree-walk exp))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_21_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function depends_on(exp, variable, frame) {
    function tree_walk(e) {
        if (is_var(e)) {
            if (equal(variable, e)) {
                return true;
            } else {
                const b = binding_in_frame(e, frame);
                if (b !== undefined) {
                    return tree_walk(binding_value(b));
                } else {
                    return false;
                }
            }
	} else if (is_pair(e)) {
            return tree_walk(head(e)) ||
                   tree_walk(tail(e));
        } else {
            return false;
        }
    }
    return tree_walk(exp);
}
</pre></div></div></td></tr></table>
    
    
  </p></div>

      

      
      <div class='permalink'>
        <a name='sec4.4.4.5' class='permalink'></a><h1>
    4.4.4.5 Maintaining the Data Base</h1></div>
  
      
  
  <div class='permalink'>
<a name='p34' class='permalink'></a><p>
    
    One important problem in designing logic programming languages is that
    of arranging things so that as few irrelevant data-base entries as
    possible will be examined in checking a given pattern.  In our
    system, in addition to storing all assertions in one big stream,
    we store all assertions whose <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span>s are constant symbols
    in separate streams, in a table indexed by the symbol.  To fetch an
    assertion that may match a pattern, we first check to see if the <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> of the pattern is a constant symbol.  If so, we return (to be
    tested using the matcher) all the stored assertions that have the same
    <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span>.  If the pattern's <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> is not a constant symbol, we
    return all the stored assertions.  Cleverer methods could also take
    advantage of information in the frame, or try also to optimize the
    case where the <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> of the pattern is not a constant symbol.  We
    avoid building our criteria for indexing (using the <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span>,
    handling only the case of constant symbols) into the program; instead
    we call on predicates and selectors that embody our criteria.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_22_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define THE-ASSERTIONS the-empty-stream)

        
        (define (fetch-assertions pattern frame)
        (if (use-index? pattern)
        (get-indexed-assertions pattern)
        (get-all-assertions)))

        (define (get-all-assertions) THE-ASSERTIONS)

        (define (get-indexed-assertions pattern)
        (get-stream (index-key-of pattern) 'assertion-stream))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_22_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
let THE_ASSERTIONS = null;

function fetch_assertions(pattern, frame) {
    return use_index(pattern)
        ? get_indexed_assertions(pattern)
        : get_all_assertions;
}
function get_all_assertions() {
    return THE_ASSERTIONS;
}
function get_indexed_assertions(pattern) {
    return get_stream(index_key_of(pattern), "assertion-stream");
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p35' class='permalink'></a><p>
    <span style="color:teal"><kbd>Get-stream</kbd></span><span style="color:blue">The function <kbd>get_stream</kbd></span>
    looks up a stream in the table and returns an empty stream if nothing is stored there.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_23_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (get-stream key1 key2)
        (let ((s (get key1 key2)))
        (if s s the-empty-stream)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_23_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function get_stream(key1, key2) {	
    const s = get(key1, key2);
    return s !== undefined ? s : null;
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p36' class='permalink'></a><p>
    Rules are stored similarly, using the <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> of the rule
    conclusion.  Rule conclusions are arbitrary patterns, however, so they
    differ from assertions in that they can contain variables.  A pattern
    whose <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> is a constant symbol can match rules whose conclusions
    start with a variable as well as rules whose conclusions have the same
    <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span>.  Thus, when fetching rules that might match a pattern whose
    <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> is a constant symbol we fetch all rules whose conclusions
    start with a variable as well as those whose conclusions have the same
    <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> as the pattern.  For this purpose we store all rules whose
    conclusions start with a variable in a separate stream in our table,
    indexed by the
    <span style="color:teal">symbol <kbd>?</kbd></span><span style="color:blue">string <kbd>"variables"</kbd></span>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_24_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define THE-RULES the-empty-stream)

        
        (define (fetch-rules pattern frame)
        (if (use-index? pattern)
        (get-indexed-rules pattern)
        (get-all-rules)))

        (define (get-all-rules) THE-RULES)

        (define (get-indexed-rules pattern)
        (stream-append
        (get-stream (index-key-of pattern) 'rule-stream)
        (get-stream '? 'rule-stream)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_24_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
let THE_RULES = null;

function fetch_rules(pattern, frame) {
    return use_index(pattern)
        ? get_indexed_rules(pattern)
        : get_all_rules();
}
function get_all_rules() {
    return THE_RULES;
}
function get_indexed_rules(pattern) {
    return stream_append(
              get_stream(index_key_of(pattern),
                         "rule-stream"),
	      get_stream("variables", "rule-stream"));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p37' class='permalink'></a><p>
    <span style="color:teal"><kbd>Add-rule-or-assertion!</kbd></span><span style="color:blue">The function <kbd>add_rule_or_assertion</kbd></span>
    is used by
    <span style="color:teal"><kbd>query-driver-loop</kbd></span><span style="color:blue"><kbd>query_driver_loop</kbd></span>
    to add assertions and rules to the data base.  Each item is stored in the
    index, if appropriate, and in a stream of all assertions or rules in
    the data base.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_25_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (add-rule-or-assertion! assertion)
        (if (rule? assertion)
        (add-rule! assertion)
        (add-assertion! assertion)))

        (define (add-assertion! assertion)
        (store-assertion-in-index assertion)
        (let ((old-assertions THE-ASSERTIONS))
        (set! THE-ASSERTIONS
              (cons-stream assertion old-assertions))
        'ok))

        (define (add-rule! rule)
        (store-rule-in-index rule)
        (let ((old-rules THE-RULES))
        (set! THE-RULES (cons-stream rule old-rules))
        'ok))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_25_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function add_rule_or_assertion(assertion) {
    return is_rule(assertion) 
        ? add_rule(assertion)
        : add_assertion(assertion);
}
function add_assertion(assertion) {
    store_assertion_in_index(assertion);
    const old_assertions = THE_ASSERTIONS;
    THE_ASSERTIONS = pair(assertion, () => old_assertions);
    return "ok";
}
function add_rule(rule) {
    store_rule_in_index(rule);
    const old_rules = THE_RULES;
    THE_RULES = pair(rule, () => old_rules);
    return "ok";
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p38' class='permalink'></a><p>  
    To actually store an assertion or a rule, we check to see if it can be
    indexed.  If so, we store it in the appropriate stream.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_26_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (store-assertion-in-index assertion)
        (if (indexable? assertion)
        (let ((key (index-key-of assertion)))
              (let ((current-assertion-stream
              (get-stream key 'assertion-stream)))
              (put key
              'assertion-stream
              (cons-stream assertion
              current-assertion-stream))))))

        (define (store-rule-in-index rule)
        (let ((pattern (conclusion rule)))
        (if (indexable? pattern)
              (let ((key (index-key-of pattern)))
              (let ((current-rule-stream
              (get-stream key 'rule-stream)))
              (put key
              'rule-stream
              (cons-stream rule
              current-rule-stream)))))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_26_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function store_assertion_in_index(assertion) {
    if (is_indexable(assertion)) {
        const key = index_key_of(assertion);
        const current_assertion_stream =
                    get_stream(key, "assertion-stream");
        put(key, "assertion-stream",
            pair(assertion, () => current_assertion_stream));
    } else {
    }
}
function store_rule_in_index(rule) {
    const pattern = conclusion(rule);
    if (is_indexable(pattern)) {
        const key = index_key_of(pattern);
        const current_rule_stream =
                    get_stream(key, "rule-stream");
        put(key, "rule-stream",
            pair(rule, () => current_rule_stream));
    } else {
    }
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p39' class='permalink'></a><p>
    The following
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    define how the data-base index is used.  A
    pattern (an assertion or a rule conclusion) will be stored in the
    table if it starts with a variable or a
    <span style="color:teal">constant symbol</span><span style="color:blue">string</span>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_27_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (indexable? pat)
        (or (constant-symbol? (car pat))
        (var? (car pat))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_27_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function indexable(pat) {	
    return is_string(pat) || is_var(head(pat));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p40' class='permalink'></a><p>
    The key under which a pattern is stored in the table is either
    <span style="color:teal"><kbd>?</kbd></span><span style="color:blue"><kbd>"variables"</kbd></span>
    (if it starts with a variable) or the
    <span style="color:teal">constant symbol</span><span style="color:blue">string</span>
    with which it starts.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_28_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (index-key-of pat)
        (let ((key (car pat)))
        (if (var? key) '? key)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_28_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function index_key_of(pat) {	
    const key = head(pat);
    return is_var(key) ? "variables" : key;
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p41' class='permalink'></a><p>
    The index will be used to retrieve items that might match a pattern if
    the pattern starts with a
    <span style="color:teal">constant symbol</span><span style="color:blue">string</span>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_29_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (use-index? pat)
        (constant-symbol? (car pat)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_29_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function use_index(pat) {	
    return is_string(head(pat));
}
</pre></div></div></td></tr></table>
  </p></div>

  
    <div class="permalink">
    <a name="ex_4.85" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.85">Exercise 4.85 </a></b> 
  
    What is the purpose of the
    <span style="color:teal"><kbd>let</kbd> bindings</span><span style="color:blue">constant declarations</span>
    in the
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    <span style="color:teal"><kbd>add-assertion!</kbd></span><span style="color:blue"><kbd>add_assertion</kbd></span>
    and
    <span style="color:teal"><kbd>add-rule!</kbd></span><span style="color:blue"><kbd>add_rule</kbd></span>?
    What would be wrong with the
    following implementation of
    <span style="color:teal"><kbd>add-assertion!</kbd></span><span style="color:blue"><kbd>add_assertion</kbd></span>?
    Hint: Recall the definition of the infinite stream of ones in
    section <REF NAME="sec:infinite-streams"><a class="superscript" id="4.4.4-sec-link-3.5.2" href="./3.5.2.html">3.5.2</a></REF>: <span style="color:teal"><kbd>(define ones (cons-stream 1 ones))</kbd></span><span style="color:blue"><kbd>const ones = pair(1, () => ones);</kbd></span>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_30_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (add-assertion! assertion)
        (store-assertion-in-index assertion)
        (set! THE-ASSERTIONS
              (cons-stream assertion THE-ASSERTIONS))
        'ok)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_30_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function add_assertion(assertion) {
    store_assertion_in_index(assertion);
    THE_ASSERTIONS = pair(assertion, () => THE_ASSERTIONS);
    return "ok";
}
</pre></div></div></td></tr></table>
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_1_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_1_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>

  

      

      
      <div class='permalink'>
        <a name='sec4.4.4.6' class='permalink'></a><h1>
    4.4.4.6 Stream Operations</h1></div>
  
      
  
  <div class='permalink'>
<a name='p42' class='permalink'></a><p>
    The query system uses a few stream operations that were not presented
    in chapter 3.
  </p></div>

  <div class='permalink'>
<a name='p43' class='permalink'></a><p>
    <span style="color:teal"><kbd>Stream-append-delayed</kbd></span><span style="color:blue">The functions <kbd>stream_append_delayed</kbd></span>
    and
    <span style="color:teal"><kbd>interleave-delayed</kbd></span><span style="color:blue"><kbd>interleave_delayed</kbd></span>
    are just like
    <span style="color:teal"><kbd>stream\?append</kbd></span><span style="color:blue"><kbd>stream_append</kbd></span>
    and
    <kbd>interleave</kbd>
    (section <REF NAME="sec:exploiting-streams"><a class="superscript" id="4.4.4-sec-link-3.5.3" href="./3.5.3.html">3.5.3</a></REF>),
    except that they take a delayed argument (like the
    <kbd>integral</kbd>
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    in section <REF NAME="sec:streams-and-delayed-evaluation"><a class="superscript" id="4.4.4-sec-link-3.5.4" href="./3.5.4.html">3.5.4</a></REF>).
    This postpones looping in some cases (see exercise <REF NAME="ex:q-why-not-append"><a class="superscript" id="4.4.4-ex-link-4.88" href="./4.4.4.html#ex_4.88">4.88</a></REF>).

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_31_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (stream-append-delayed s1 delayed-s2)
        (if (stream-null? s1)
        (force delayed-s2)
        (cons-stream
        (stream-car s1)
        (stream-append-delayed (stream-cdr s1) delayed-s2))))

        
        (define (interleave-delayed s1 delayed-s2)
        (if (stream-null? s1)
        (force delayed-s2)
        (cons-stream
        (stream-car s1)
        (interleave-delayed (force delayed-s2)
              (delay (stream-cdr s1))))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_31_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function stream_append_delayed(s1, delayed_s2) {
    return is_null(s1)
        ? delayed_s2()
        : pair(head(s1),
               () => stream_append_delayed(stream_tail(s1),
      	                                   delayed_s2));
}
function interleave_delayed(s1, delayed_s2) {
    return is_null(s1)
        ? delayed_s2()
        : pair(head(s1),
               () => interleave_delayed(delayed_s2(),
                         () => stream_tail(s1)));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p44' class='permalink'></a><p>
    <span style="color:teal"><kbd>Stream-flatmap</kbd></span><span style="color:blue">The function <kbd>stream_flatmap</kbd></span>,
    which is used throughout the query evaluator to map a
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    over a stream of frames and combine the resulting
    streams of frames, is the stream analog of the <kbd>flatmap</kbd>
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    introduced for ordinary lists in section <REF NAME="sec:nested-mappings"><a class="superscript" id="4.4.4-sec-link-2.2.3" href="./2.2.3.html">2.2.3</a></REF>.
    Unlike ordinary <kbd>flatmap</kbd>, however, we accumulate the streams with
    an interleaving process, rather than simply appending them (see
    exercises <REF NAME="ex:q-why-interleave"><a class="superscript" id="4.4.4-ex-link-4.89" href="./4.4.4.html#ex_4.89">4.89</a></REF> and  <REF NAME="ex:q-why-delay"><a class="superscript" id="4.4.4-ex-link-4.90" href="./4.4.4.html#ex_4.90">4.90</a></REF>).

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_32_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (stream-flatmap proc s)
        (flatten-stream (stream-map proc s)))

        
        (define (flatten-stream stream)
        (if (stream-null? stream)
        the-empty-stream
        (interleave-delayed
        (stream-car stream)
        (delay (flatten-stream (stream-cdr stream))))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_32_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function stream_flatmap(fun, s) {
    return flatten_stream(stream_map(fun, s));
}
function flatten_stream(stream) {
    return is_null(stream)
        ? null
        : interleave_delayed(head(stream),
              () => flatten_stream(stream_tail(stream)));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p45' class='permalink'></a><p>
    The evaluator also uses the following simple
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    to generate a stream consisting of a single element:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_33_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (singleton-stream x)
        (cons-stream x the-empty-stream))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_33_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function singleton_stream(x) {	
    pair(x, () => null);
}
</pre></div></div></td></tr></table>
    
  </p></div>
      

      
      <div class='permalink'>
        <a name='sec4.4.4.7' class='permalink'></a><h1>
    4.4.4.7 Query Syntax
    <span style="color:teal">Procedures</span><span style="color:blue">Functions</span></h1></div>
      
      
  
  <div class='permalink'>
<a name='p46' class='permalink'></a><p>
    <span style="color:teal"><kbd>Type</kbd></span><span style="color:blue">The functions <kbd>type</kbd></span>
    and <kbd>contents</kbd>, used by <kbd>qeval</kbd>
    (section <REF NAME="sec:query-eval"><a class="superscript" id="4.4.4-sec-link-4.4.4.2" href="./4.4.4.html#sec4.4.4.2">4.4.4.2</a></REF>), specify that a
    <span style="color:teal">special form</span><span style="color:blue">query expression</span>
    is identified by <span style="color:teal">the symbol in its <kbd>car</kbd></span><span style="color:blue">name of its operator</span>.
    <span style="color:teal">They are the same as the
    <span style="color:teal"><kbd>type-tag</kbd></span><span style="color:blue"><kbd>type_tag</kbd></span>
    and <kbd>contents</kbd>
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    in section <REF NAME="sec:manifest-types"><a class="superscript" id="4.4.4-sec-link-2.4.2" href="./2.4.2.html">2.4.2</a></REF>, except for the error message.</span>

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_34_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (type exp)
        (if (pair? exp)
        (car exp)
        (error "Unknown expression TYPE" exp)))

        (define (contents exp)
        (if (pair? exp)
        (cdr exp)
        (error "Unknown expression CONTENTS" exp)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_34_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function type(exp) {
    return is_application(exp) && is_name(operator(exp))
        ? name_of_name(operator(exp))
        : error(exp, "Unknown expression TYPE");
}
function contents(exp) {
    return is_application(exp) && is_name(operator(exp))
        ? operands(exp)
        : error(exp, "Unknown expression CONTENTS");
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p47' class='permalink'></a><p>
    The following
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>, used by
    <span style="color:teal"><kbd>query-driver-loop</kbd></span><span style="color:blue"><kbd>query_driver_loop</kbd></span>
    (in section <REF NAME="sec:query-driver"><a class="superscript" id="4.4.4-sec-link-4.4.4.1" href="./4.4.4.html#sec4.4.4.1">4.4.4.1</a></REF>), specify
    that rules and assertions are added to the data base by expressions of
    the form <span style="color:teal"><kbd>(assert! ^rule-or-assertion^)</kbd></span><span style="color:blue"><kbd>assert(</kbd>$\textit{rule-or-assertion}$<kbd>)</kbd></span>:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_35_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (assertion-to-be-added? exp)
        (eq? (type exp) 'assert!))

        (define (add-assertion-body exp)
        (car (contents exp)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_35_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function assertion_to_be_added(exp) {
    return type(exp) === "assert";
}
function add_assertion_body(exp) {
    return head(contents(exp));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p48' class='permalink'></a><p>
    Here are the syntax definitions for the <kbd>and</kbd>, <kbd>or</kbd>, <kbd>not</kbd>, and
    <span style="color:teal"><kbd>lisp-value</kbd> special forms</span>
    <span style="color:blue"><kbd>javascript_value</kbd> query expressions</span>
    (section <REF NAME="sec:query-eval"><a class="superscript" id="4.4.4-sec-link-4.4.4.2" href="./4.4.4.html#sec4.4.4.2">4.4.4.2</a></REF>):

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_36_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (empty-conjunction? exps) (null? exps))
        (define (first-conjunct exps) (car exps))
        (define (rest-conjuncts exps) (cdr exps))

        (define (empty-disjunction? exps) (null? exps))
        (define (first-disjunct exps) (car exps))
        (define (rest-disjuncts exps) (cdr exps))

        (define (negated-query exps) (car exps))

        (define (predicate exps) (car exps))
        (define (args exps) (cdr exps))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_36_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function empty_conjunction(exps) {
    return is_null(exps);
}
function first_conjunct(exps) {
    return head(exps);
}
function rest_conjuncts(exps) {
    return tail(exps);
}
function is_empty_disjunction(exps) {
    return is_null(exps);
}
function first_disjunct(exps) {
    return head(exps);
}
function rest_disjuncts(exps) {
    return tail(exps);
}
function negated_query(exps) {
    return head(exps);
}
function predicate(exps) {
    return head(exps);
}
function args(exps) {
    return tail(exps);
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p49' class='permalink'></a><p>
    The following three
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    define the syntax of rules:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_37_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (rule? statement)
        (tagged-list? statement 'rule))

        (define (conclusion rule) (cadr rule))

        (define (rule-body rule)
        (if (null? (cddr rule))
        '(always-true)
        (caddr rule)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_37_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function is_rule(statement) {
    return is_application(statement) &&  
           is_name(operator(statement)) &&
           name_of_name(operator(statement)) === "rule";
}
function conclusion(rule) {
    return head(operands(rule));
}
function rule_body(rule) {
    return is_null(tail(operands(rule)))
        ? "always_true"
        : tail(operands(rule));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p50' class='permalink'></a><p>
    
    
    <span style="color:teal"><kbd>Query-driver-loop</kbd></span><span style="color:blue">The function <kbd>query_driver_loop</kbd></span>
    (section <REF NAME="sec:query-driver"><a class="superscript" id="4.4.4-sec-link-4.4.4.1" href="./4.4.4.html#sec4.4.4.1">4.4.4.1</a></REF>)
    calls
     <span style="color:teal"><kbd>query-syntax-process</kbd></span><span style="color:blue"><kbd>query_syntax_process</kbd></span>
    to
    transform pattern variables in the expression, which
    <span style="color:teal">have the form <kbd>?symbol</kbd>,</span>
    <span style="color:blue">are names,</span>
    into the internal format <span style="color:teal"><kbd>(? symbol)</kbd></span><span style="color:blue"><kbd>list("?", name)</kbd></span>.  That is to
    say, a pattern such as <span style="color:teal"><kbd>(job ?x ?y)</kbd></span><span style="color:blue"><kbd>list(x, y)</kbd></span> is actually represented
    internally by the system as <span style="color:teal"><kbd>(job (? x) (? y))</kbd></span><span style="color:blue"><kbd>list(list("?", "x"), list("?", "y"))</kbd></span>.  <span style="color:teal">This increases
    the efficiency of query processing, since it means that the system can check to see if an expression is a pattern variable by checking
    whether the <span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span> of the expression is the symbol <kbd>?</kbd>, rather
    than having to extract characters from the symbol.</span>
    The syntax
    transformation is accomplished by the following
    <span style="color:teal">procedure</span><span style="color:blue">function</span>:<span style="color:teal"><a class='superscript' id='footnote-link-2' href='#footnote-2'style="color:teal">[2]</a></span>

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_38_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (query-syntax-process exp)
        (map-over-symbols expand-question-mark exp))

        
        (define (map-over-symbols proc exp)
        (cond ((pair? exp)
              (cons (map-over-symbols proc (car exp))
              (map-over-symbols proc (cdr exp))))
              ((symbol? exp) (proc exp))
              (else exp)))

        (define (expand-question-mark symbol)
        (let ((chars (symbol->string symbol)))
        (if (string=? (substring chars 0 1) "?")
              (list '?
              (string->symbol
              (substring chars 1 (string-length chars))))
              symbol)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_38_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function query_syntax_process(exp) {
    return map_over_names(expand_question_mark, exp);
}
function map_over_names(fun, exp) {
    return is_name(exp) 
        ? fun(exp)
        : is_pair(exp)
        ? pair(map_over_names(fun, head(exp)),
               map_over_names(fun, tail(exp)))
        : exp;
}
function expand_question_mark(name) {
    return list("?", name_of_name(name));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p51' class='permalink'></a><p>
    Once the variables are transformed in this way, the variables in a
    pattern are lists starting with
    <span style="color:teal"><kbd>?</kbd></span><span style="color:blue"><kbd>"?"</kbd></span>,
    and the <span style="color:teal">constant symbols</span><span style="color:blue">strings</span> (which need to be recognized for
    data-base indexing, section <REF NAME="sec:query-db"><a class="superscript" id="4.4.4-sec-link-4.4.4.5" href="./4.4.4.html#sec4.4.4.5">4.4.4.5</a></REF>) are just the
    <span style="color:teal">symbols</span><span style="color:blue">strings</span>.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_39_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (var? exp)
        (tagged-list? exp '?))

        (define (constant-symbol? exp) (symbol? exp))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_39_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function is_var(exp) {	
    return is_tagged_list(exp, "?");
}
function is_constant_string(exp) {
    return is_string(exp);
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p52' class='permalink'></a><p>
    Unique variables are constructed during rule application
    (in section <REF NAME="sec:query-unify"><a class="superscript" id="4.4.4-sec-link-4.4.4.4" href="./4.4.4.html#sec4.4.4.4">4.4.4.4</a></REF>) by means of
    the following
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>.  The unique identifier for a rule
    application is a number, which is incremented each time a rule is
    applied.

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_40_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define rule-counter 0)

        (define (new-rule-application-id)
        (set! rule-counter (+ 1 rule-counter))
        rule-counter)

        (define (make-new-variable var rule-application-id)
        (cons '? (cons rule-application-id (cdr var))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_40_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
let rule_counter = 0;

function new_rule_application_id() {
    rule_counter = rule_counter + 1;
    return rule_counter;
}
function make_new_variable(variable, rule_application_id) {
    return list("?", tail(variable) + stringify(rule_application_id));
}
</pre></div></div></td></tr></table>
  </p></div>

  <div class='permalink'>
<a name='p53' class='permalink'></a><p>
    When
    <span style="color:teal"><kbd>query-driver-loop</kbd></span><span style="color:blue"><kbd>query_driver_loop</kbd></span>
    instantiates the query to print the
    answer, it converts any unbound pattern variables back to the right
    form for printing, using

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_41_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (contract-question-mark variable)
        (string->symbol
        (string-append "?" 
        (if (number? (cadr variable))
              (string-append (symbol->string (caddr variable))
              "-"
              (number->string (cadr variable)))
              (symbol->string (cadr variable))))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_41_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function contract_question_mark(variable) {
    return list("name", tail(variable));
}
</pre></div></div></td></tr></table>
    
    
    
  </p></div>
      

      
      <div class='permalink'>
        <a name='sec4.4.4.8' class='permalink'></a><h1>
    4.4.4.8 Frames and Bindings</h1></div>
  

  <div class='permalink'>
<a name='p54' class='permalink'></a><p>
    
    
    Frames are represented as lists of bindings, which are
    variable-value pairs:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_42_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (make-binding variable value)
        (cons variable value))

        (define (binding-variable binding)
        (car binding))

        (define (binding-value binding)
        (cdr binding))

        (define (binding-in-frame variable frame)
        (assoc variable frame))

        (define (extend variable value frame)
        (cons (make-binding variable value) frame))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_42_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function make_binding(variable, value) {
    return pair(variable, value);
}
function binding_variable(binding) {
    return head(binding);
}
function binding_value(binding) {
    return tail(binding);
}
function binding_in_frame(variable, frame) {
    return assoc(variable, frame);
}
function extend(variable, value, frame) {
    return pair(make_binding(variable, value), frame);
}
</pre></div></div></td></tr></table>
    
  </p></div>

  
    <div class="permalink">
    <a name="ex_4.88" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.88">Exercise 4.88 </a></b> 
  
    Louis Reasoner wonders why the
    <span style="color:teal"><kbd>simple-query</kbd></span><span style="color:blue"><kbd>simple_query</kbd></span>
    and <kbd>disjoin</kbd>
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>
    (section <REF NAME="sec:query-eval"><a class="superscript" id="4.4.4-sec-link-4.4.4.2" href="./4.4.4.html#sec4.4.4.2">4.4.4.2</a></REF>) are implemented using
    explicit
    <span style="color:teal"><kbd>delay</kbd></span><span style="color:blue">delay</span>
    operations, rather than being defined as follows:

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_43_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (simple-query query-pattern frame-stream)
        (stream-flatmap
        (lambda (frame)
        (stream-append (find-assertions query-pattern frame)
              (apply-rules query-pattern frame)))
        frame-stream))

        (define (disjoin disjuncts frame-stream)
        (if (empty-disjunction? disjuncts)
        the-empty-stream
        (interleave
        (qeval (first-disjunct disjuncts) frame-stream)
        (disjoin (rest-disjuncts disjuncts) frame-stream))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_43_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function simple_query(query_pattern, frame_stream) {
    return stream_flatmap(
              frame =>
                 stream_append(find_assertions(query_pattern, frame),
                               apply_rules(query_pattern, frame)),
              frame_stream);
}
function disjoin(disjuncts, frame_stream) {
    return is_empty_disjunction(disjuncts)
        ? null
        : interleave(qeval(first_disjunct(disjuncts), frame_stream),
                     disjoin(rest_disjuncts(disjuncts), frame_stream));
}
</pre></div></div></td></tr></table>
    Can you give examples of queries where these simpler definitions would
    lead to undesirable behavior?
    
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_2_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_2_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>


  
    <div class="permalink">
    <a name="ex_4.89" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.89">Exercise 4.89 </a></b> 
  
    Why do <kbd>disjoin</kbd> and
    <span style="color:teal"><kbd>stream-flatmap</kbd></span><span style="color:blue"><kbd>stream_flatmap</kbd></span>
    interleave the
    streams rather than simply append them?  Give examples that illustrate
    why interleaving works better.  (Hint: Why did we use <kbd>interleave</kbd> in
    section <REF NAME="sec:exploiting-streams"><a class="superscript" id="4.4.4-sec-link-3.5.3" href="./3.5.3.html">3.5.3</a></REF>?)
    
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_3_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_3_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>


  
    <div class="permalink">
    <a name="ex_4.90" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.90">Exercise 4.90 </a></b> 
  
  Why does
  <span style="color:teal"><kbd>flatten-stream</kbd></span><span style="color:blue"><kbd>flatten_stream</kbd></span>
  use
  <span style="color:teal"><kbd>delay</kbd> explicitly?</span><span style="color:blue">a lambda expression in its body?</span>
    What would be wrong with defining it as follows:
    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_44_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (flatten-stream stream)
        (if (stream-null? stream)
        the-empty-stream
        (interleave
        (stream-car stream)
        (flatten-stream (stream-cdr stream)))))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_44_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function flatten_stream(stream) {
    return is_null(stream)
        ? null
        : interleave(head(stream),
                     flatten_stream(stream_tail(stream)));
}
</pre></div></div></td></tr></table>
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_4_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_4_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>


  
    <div class="permalink">
    <a name="ex_4.87" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.87">Exercise 4.87 </a></b> 
  
    
    Alyssa P. Hacker proposes to use a simpler version of
    <span style="color:teal"><kbd>stream-flatmap</kbd></span><span style="color:blue"><kbd>stream_flatmap</kbd></span>
    in <kbd>negate</kbd>,
    <span style="color:teal"><kbd>lisp-value</kbd></span><span style="color:blue"><kbd>javascript_value</kbd></span>,
    and
    <span style="color:teal"><kbd>find-assertions</kbd></span><span style="color:blue"><kbd>find_assertions</kbd></span>.
    She observes that the
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    that is mapped over the frame stream
    in these cases always produces either the empty stream or a singleton
    stream, so no interleaving is needed when combining these streams.
    <OL>
      <LI>
        Fill in the missing expressions in Alyssa's program.
        <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_45_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (simple-stream-flatmap proc s)
      (simple-flatten (stream-map proc s)))

      (define (simple-flatten stream)
      (stream-map ^??^
      (stream-filter ^??^ stream)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_45_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
function simple_stream_flatmap(fun, s) {
    return simple_flatten(stream_map(fun, s));
}
function simple_flatten(stream) {
    return stream_map(...,
                      stream_filter(..., stream));
}
</pre></div></div></td></tr></table>
      </LI>
      <LI>
        Does the query system's behavior change if we change it in this way?
      </LI>
    </OL>
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_5_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_5_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>


  
    <div class="permalink">
    <a name="ex_4.92" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.92">Exercise 4.92 </a></b> 
  
    
    
    
    Implement for the query language a
    <span style="color:teal">new special form called <kbd>unique</kbd></span><span style="color:blue">query expression called <kbd>unique</kbd></span>. <kbd>Unique</kbd> should succeed if there is precisely one item
    in the data base satisfying a specified query.  For example,

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_46_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(unique (job ?x (computer wizard)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_46_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
unique(job(x, list("computer", "wizard")));
</pre></div></div></td></tr></table>

    should print the one-item stream

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_47_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(unique (job (Bitdiddle Ben) (computer wizard)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_47_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
unique(job(list("Bitdiddle", "Ben"), list("computer", "wizard")))
</pre></div></div></td></tr></table>

    since Ben is the only computer wizard, and

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_48_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(unique (job ?x (computer programmer)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_48_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
unique(job(x, list("computer", "programmer")));
</pre></div></div></td></tr></table>
    should print the empty stream, since there is more than one computer
    programmer.  Moreover,
    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_49_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(and (job ?x ?j) (unique (job ?anyone ?j)))
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_49_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
and(job(x, j), unique(job(anyone, j)));
</pre></div></div></td></tr></table>
    should list all the jobs that are filled by only one person, and the
    people who fill them.

    There are two parts to implementing <kbd>unique</kbd>.  The first is to
    write a
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    that handles this special form, and the second is to make
    <kbd>qeval</kbd> dispatch to that
    <span style="color:teal">procedure</span><span style="color:blue">function</span>.  The second part is trivial,
    since <kbd>qeval</kbd> does its dispatching in a data-directed way.  If
    your
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    is called
    <span style="color:teal"><kbd>uniquely-asserted</kbd></span><span style="color:blue"><kbd>uniquely_asserted</kbd></span>,
    all you need to do is
    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_50_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(put 'unique 'qeval uniquely-asserted)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_50_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
put("unique", "qeval", uniquely_asserted);
</pre></div></div></td></tr></table>

    and <kbd>qeval</kbd> will dispatch to this
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    for every query whose
    <kbd>type</kbd> (<span style="color:teal"><kbd>car</kbd></span><span style="color:blue"><kbd>head</kbd></span>) is the
    <span style="color:teal">symbol</span><span style="color:blue">nam</span> <kbd>unique</kbd>.

    The real problem is to write the
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    <span style="color:teal"><kbd>uniquely-asserted</kbd></span><span style="color:blue"><kbd>uniquely_asserted</kbd></span>.
    This should take as input the <kbd>contents</kbd> (<span style="color:teal"><kbd>cdr</kbd></span><span style="color:blue"><kbd>tail</kbd></span>) of the <kbd>unique</kbd> query, together with a stream of frames.  For each frame in
    the stream, it should use <kbd>qeval</kbd> to find the stream of all
    extensions to the frame that satisfy the given query.  Any stream that
    does not have exactly one item in it should be eliminated.  The
    remaining streams should be passed back to be accumulated into one big
    stream that is the result of the <kbd>unique</kbd> query.  This is similar
    to the implementation of the <kbd>not</kbd> special form.

    Test your implementation by forming a query that lists all people who
    supervise precisely one person.
    
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_6_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_6_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>


  
    <div class="permalink">
    <a name="ex_4.93" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.93">Exercise 4.93 </a></b> 
  
    
    
    
    Our implementation of <kbd>and</kbd> as a series combination of queries
    (figure <REF NAME="fig:query-and"><a class="superscript" id="4.4.4-fig-link-4.7" href="./4.4.2.html#fig_4.7">4.7</a></REF>) is elegant, but it is inefficient because in
    processing the second query of the <kbd>and</kbd> we must scan the data
    base for each frame produced by the first query.  If the data base has
    $N$ elements, and a typical query produces a number of output frames
    proportional to $N$ (say $N/k$), then scanning the data base for each
    frame produced by the first query will require $N^{2}/k$ calls to the
    pattern matcher.  Another approach would be to process the two clauses
    of the <kbd>and</kbd> separately, then look for all pairs of output frames
    that are compatible.  If each query produces $N/k$ output frames, then
    this means that we must perform $N^{2}/k^{2}$ compatibility checks—a
    factor of $k$ fewer than the number of matches required in our current
    method.

    Devise an implementation of <kbd>and</kbd> that uses this strategy.  You
    must implement a
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    that takes two frames as inputs, checks
    whether the bindings in the frames are compatible, and, if so,
    produces a frame that merges the two sets of bindings.  This operation
    is similar to unification.
    
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_7_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_7_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>


  
    <div class="permalink">
    <a name="ex_4.94" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.94">Exercise 4.94 </a></b> 
  
    
    
    
    
    
    In section <REF NAME="sec:math-logic"><a class="superscript" id="4.4.4-sec-link-4.4.3" href="./4.4.3.html">4.4.3</a></REF> we saw that <kbd>not</kbd> and
    <span style="color:teal"><kbd>lisp-value</kbd></span><span style="color:blue"><kbd>javascript_value</kbd></span>
    can cause the query language to give <QUOTE>wrong</QUOTE> answers if
    these filtering operations are applied to frames in which variables
    are unbound.  Devise a way to fix this shortcoming.  One idea is to
    perform the filtering in a <QUOTE>delayed</QUOTE> manner by appending to the
    frame a <QUOTE>promise</QUOTE> to filter that is fulfilled only when enough
    variables have been bound to make the operation possible.  We could
    wait to perform filtering until all other operations have been
    performed.  However, for efficiency's sake, we would like to perform
    filtering as soon as possible so as to cut down on the number of
    intermediate frames generated.
    
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_8_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_8_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>


  
    <div class="permalink">
    <a name="ex_4.95" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.95">Exercise 4.95 </a></b> 
  
    
    Redesign the query language as a nondeterministic program to be
    implemented using the evaluator of
    section <REF NAME="sec:nondeterministic-evaluation"><a class="superscript" id="4.4.4-sec-link-4.3" href="./4.3.html">4.3</a></REF>, rather than as a stream
    process.  In this approach, each query will produce a single answer
    (rather than the stream of all answers) and the user can type <kbd>try-again</kbd> to see more answers.  You should find that much of the
    mechanism we built in this section is subsumed by nondeterministic
    search and backtracking.  You will probably also find, however, that
    your new query language has subtle differences in behavior from the
    one implemented here.  Can you find examples that illustrate this
    difference?
    
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_9_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_9_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>



  
    <div class="permalink">
    <a name="ex_4.96" class="permalink"></a><EXERCISE><b><a class="exercise-number permalink" id="ex_4.96">Exercise 4.96 </a></b> 
  
    
    
    When we implemented the <span style="color:teal">Lisp</span><span style="color:blue">JavaScript</span> evaluator in section <REF NAME="sec:mc-eval"><a class="superscript" id="4.4.4-sec-link-4.1" href="./4.1.html">4.1</a></REF>,
    we saw how to use local environments to avoid name conflicts between
    the parameters of
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>.  For example, in evaluating

    <table width="100%">
          <colgroup><col width="48%"><col width="52%"></colgroup>
          
          <tr>
            <td><div class='snippet' id='javascript_95_51_div'><div class='pre-prettyprint'><pre class='prettyprint no-eval'>
(define (square x)
        (* x x))

        (define (sum-of-squares x y)
        (+ (square x) (square y)))

        (sum-of-squares 3 4)
</pre></div></div>    </td>
            <td><div class='snippet' id='javascript_95_51_div'><div class='pre-prettyprint'><pre class='prettyprint' title='Evaluate Javascript expression'onclick="window.open('http://source-academy.github.io/playground#chap=4&prgrm=PTAEGUEkGEAVQFLlAFgHTpQKCwMwK4B2AxgC4CWA9oaAM4CO+AhgE4CmAFAB4CUoA3llDDQ7UvhY0uoAFSguAbiwBfPETJUatfAFsA+pVx6GzdrW4AaUAE8+gkaLbjJdRq069QAalenOtpVVtfUNjNzMOAGYrFB4FIA')">function square(x) {
    return x * x;
}
function sum_of_squares(x, y) {
    return square(x) + square(y);
}
sum_of_squares(3, 4);

</pre></div></div></td></tr></table>

    there is no confusion between the <kbd>x</kbd> in <kbd>square</kbd> and the <kbd>x</kbd>
    in
    <span style="color:teal"><kbd>sum-of-squares</kbd></span><span style="color:blue"><kbd>sum_of_squares</kbd></span>,
    because we evaluate the body of each
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    in an environment that is specially constructed to contain
    bindings for the local variables.  In the query system, we used a
    different strategy to avoid name conflicts in applying rules.  Each
    time we apply a rule we rename the variables with new names that are
    guaranteed to be unique.  The analogous strategy for the <span style="color:teal">Lisp</span><span style="color:blue">JavaScript</span>
    evaluator would be to do away with local environments and simply
    rename the variables in the body of a
    <span style="color:teal">procedure</span><span style="color:blue">function</span>
    each time we apply the
    <span style="color:teal">procedure</span><span style="color:blue">function</span>.

    
    
    
    
    Implement for the query language a rule-application method that uses
    environments rather than renaming.  See if you can build on your
    environment structure to create constructs in the query language for
    dealing with large systems, such as the rule analog of
    block-structured
    <span style="color:teal">procedures</span><span style="color:blue">functions</span>.  Can you relate any of this to the
    problem of making deductions in a context (e.g., <QUOTE>If I supposed that
      $P$ were true, then I would be able to deduce $A$ and $B$.</QUOTE>) as a
    method of problem solving?  (This problem is open-ended.  A good
    answer is probably worth a Ph.D.)
    
  
      <div class="Solution">
      <div class="solution_btn"><button class="btn btn-secondary solution_btn" href="#no_solution_95_10_div" data-toggle="collapse">Add solution</button></div>
      <div class="solution_content collapse" id="no_solution_95_10_div">There is currently no solution available for this exercise. This textbook adaptation is a community effort. Do consider contributing by providing a solution for this exercise, using a Pull Request in <a address="https://github.com/source-academy/sicp" href="https://github.com/source-academy/sicp">Github</a>.</div>
      </div>
    
</EXERCISE></div>

    
    <hr>

    <div class='footnote'>
      <a class='footnote-number' id='footnote-1' href='#footnote-link-1' >[1] </a>
    <FOOTNOTE>
    In general, unifying
    <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
    with an expression involving
      
      <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
      would require our being able to find a fixed point of the
      equation
      <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>
      $=$
      <span style="color:teal"><kbd>^expression involving^ ?y</kbd></span><span style="color:blue">$\textit{expression involving}$<kbd>y</kbd></span>.
      It is sometimes possible to syntactically form an expression that appears to
      be the solution.  For example,
      <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span> $=$ <span style="color:teal"><kbd>(f ?y)</kbd></span><span style="color:blue"><kbd>list("f", y)</kbd></span> seems to have
      the fixed point
      <span style="color:teal"><kbd>(f (f (f </kbd>…<kbd>)))</kbd></span><span style="color:blue"><kbd>list("f", list("f", list("f",</kbd>…<kbd>)))</kbd></span>, which we can produce by
      beginning with the expression
      <span style="color:teal"><kbd>(f ?y)</kbd></span><span style="color:blue"><kbd>list("f", y)</kbd></span>
      and repeatedly substituting
      <span style="color:teal"><kbd>(f ?y)</kbd></span><span style="color:blue"><kbd>list("f", y)</kbd></span>
      for
      <span style="color:teal"><kbd>?y</kbd></span><span style="color:blue"><kbd>y</kbd></span>.
      Unfortunately, not every such equation has
      a meaningful fixed point.  The issues that arise here are similar to
      the issues of manipulating 
      
      infinite series in mathematics.  For
      example, we know that 2 is the solution to the equation $y = 1 + y/2$.
      Beginning with the expression $1 + y/2$ and repeatedly substituting $1
        + y/2$ for $y$ gives
      
        \[ 2 = y = 1 + y/2 = 1 + (1+y/2)/2 = 1 + 1/2 + y/4 =\cdots, \]
      

      which leads to
      
        \[ 2 = 1 + 1/2 + 1/4 + 1/8 +\cdots. \]
      

      However, if we try the same manipulation beginning with the
      observation that $-1$ is the solution to the equation $y = 1 + 2y$, we
      obtain
      
        \[ -1 = y = 1 + 2y = 1 + 2(1 + 2y) = 1 + 2 + 4y = \cdots, \]
      

      which leads to 
      
        \[ -1 = 1 + 2 + 4 + 8 +\cdots. \]
      
      Although the formal manipulations used in deriving these two equations
      are identical, the first result is a valid assertion about infinite
      series but the second is not.  Similarly, for our unification results,
      reasoning with an arbitrary syntactically constructed expression may
      lead to errors.
    </FOOTNOTE></div>
    
    
    <div class='footnote'><span style="color:teal">
      <a class='footnote-number' id='footnote-2' href='#footnote-link-2' style="color:teal">[2] </a>
    <FOOTNOTE>
    Most <span style="color:teal">Lisp</span><span style="color:blue">JavaScript</span> systems give the user the ability to
      modify the ordinary <kbd>read</kbd>
      <span style="color:teal">procedure</span><span style="color:blue">function</span>
      to perform such
      transformations by defining 
      
      
      
      
      <EM>reader macro characters</EM>.  Quoted
      expressions are already handled in this way: The reader automatically
      translates <kbd>'expression</kbd> into <span style="color:teal"><kbd>(quote expression)</kbd></span><span style="color:blue"><kbd>???</kbd></span> before the
      evaluator sees it.  We could arrange for <kbd>?expression</kbd> to be
      transformed into <span style="color:teal"><kbd>(? expression)</kbd></span><span style="color:blue"><kbd>???</kbd></span> in the same way; however, for
      the sake of clarity we have included the transformation
      <span style="color:teal">procedure</span><span style="color:blue">function</span>
      here
      explicitly.

      
      <kbd>Expand-question-mark</kbd> and <kbd>contract-question-mark</kbd> use
      several
      <span style="color:teal">procedures</span><span style="color:blue">functions</span>
      with <kbd>string</kbd> in their names.
      These are Scheme primitives.
    
    </FOOTNOTE></span></div>
    
    
</SUBSECTION></div></div>

    <div class='nav'>
  
        <a class='btn btn-secondary btn-nav' href='./4.4.3.html'>&lt; Previous</a>
    
    <div style='flex-grow: 1;'></div>
  
        <a class='btn btn-secondary btn-nav' id='97' href='./5.html'>Next &gt;</a>
      </div>
    <div class='chapter_sign'>
      4.4.4  Implementing the Query System
    </div>
    <script> var chapter_id = 96; </script>
    <script> var chapter_path = "chapters/4.4.4.html"; </script>
    <div class='next-page'></div>
    </div>
    </div> <!-- /.container -->
    </body></html>